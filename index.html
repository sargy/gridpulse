<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GridPulse</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Fraunces:ital,wght@0,100;0,300;1,100&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #07070f;
    --surface: #10101a;
    --surface2: #18182a;
    --border: rgba(255,255,255,0.07);
    --accent: #c8ff00;
    --text: #e8e8f0;
    --muted: rgba(232,232,240,0.4);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { height: 100%; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    height: 100vh;        /* fallback for older browsers */
    height: 100dvh;       /* dynamic viewport height ‚Äî excludes iOS Safari browser chrome */
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    padding: 0.7rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
    z-index: 100;
    background: var(--bg);
    overflow-x: auto;
  }

  h1 {
    font-family: 'Fraunces', serif;
    font-weight: 100;
    font-size: 1.5rem;
    letter-spacing: -0.02em;
    white-space: nowrap;
  }
  h1 em { font-style: italic; color: var(--accent); }

  .header-divider {
    width: 1px; height: 2rem;
    background: var(--border);
    flex-shrink: 0;
  }

  /* Next race block in header */
  .hdr-race-block {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    cursor: pointer;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    transition: background 0.15s;
    flex-shrink: 0;
  }
  .hdr-race-block:hover { background: rgba(255,255,255,0.05); }
  .next-race {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }
  .next-race-label {
    font-size: 0.52rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .next-race-name {
    font-family: 'Fraunces', serif;
    font-size: 1rem;
    font-weight: 300;
    color: var(--text);
    line-height: 1;
  }
  .next-race-location {
    font-size: 0.58rem;
    color: var(--muted);
  }

  .header-countdown {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.1rem;
  }
  .header-countdown-label {
    font-size: 0.52rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,100,100,0.7);
  }
  .header-countdown-value {
    font-size: 1.3rem;
    font-weight: 500;
    color: #ff6060;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.02em;
    line-height: 1;
    white-space: nowrap;
  }

  .hint {
    font-size: 0.55rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    white-space: nowrap;
    margin-left: auto;
  }

  /* ‚îÄ‚îÄ News bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #news-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0 1.2rem;
    background: var(--surface2);
    border: none;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    flex-shrink: 0;
    height: 34px;
    z-index: 10;
    position: relative;
    transition: background 0.15s;
    overflow: hidden;
    user-select: none;
  }
  #news-filter-bar {
    display: flex;
    gap: 0.3rem;
    flex-shrink: 0;
    align-items: center;
  }
  #news-toggle:hover { background: rgba(255,255,255,0.05); }
  #news-toggle .nt-label {
    white-space: nowrap;
    flex-shrink: 0;
    color: var(--text);
  }
  #news-toggle .nt-divider {
    width: 1px; height: 14px; background: var(--border); flex-shrink: 0;
  }
  #news-toggle .nt-arrow {
    font-size: 0.5rem; transition: transform 0.3s; flex-shrink: 0; margin-left: 0.4rem;
  }
  #news-toggle.open .nt-arrow { transform: rotate(180deg); }
  #news-toggle .nt-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent); flex-shrink: 0;
    box-shadow: 0 0 6px var(--accent);
    animation: dot-pulse 2s ease-in-out infinite;
  }
  @keyframes dot-pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
  }

  /* Ticker ‚Äî scrolling strip of headlines, hidden when dropdown open */
  #news-ticker-wrap {
    flex: 1;
    overflow: hidden;
    height: 100%;
    display: flex;
    align-items: center;
    mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
    -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
  }
  #news-ticker {
    display: flex;
    gap: 3rem;
    white-space: nowrap;
    animation: ticker-scroll 60s linear infinite;
    will-change: transform;
  }
  #news-ticker:hover { animation-play-state: paused; }
  @keyframes ticker-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.15s;
  }
  .ticker-item:hover { color: var(--text); }
  .ticker-badge {
    font-size: 0.52rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 1px 5px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  .ticker-badge.f1   { background: rgba(230,0,0,0.25);   color:#ff6060; }
  .ticker-badge.fe   { background: rgba(180,0,255,0.2);   color:#d070ff; }
  .ticker-badge.indy { background: rgba(255,220,0,0.2);   color:#ffe040; }
  .ticker-sep { color: var(--border); font-size: 0.8rem; }

  /* Collapsible dropdown */
  #news-bar {
    flex-shrink: 0;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    overflow: hidden;
    transition: max-height 0.35s ease;
    max-height: 0;
  }
  #news-bar.open { max-height: 268px; }

  #news-list {
    overflow-y: auto;
    max-height: 268px;
    padding: 0.4rem 0;
    scroll-behavior: smooth;
  }
  #news-list::-webkit-scrollbar { width: 3px; }
  #news-list::-webkit-scrollbar-thumb { background: var(--border); }

  .news-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: start;
    gap: 0.4rem 0.9rem;
    padding: 0.8rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    text-decoration: none;
    transition: background 0.15s;
  }
  .news-item:last-child { border-bottom: none; }
  .news-item:hover { background: var(--surface2); }
  .news-badge {
    font-size: 0.58rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 3px 6px;
    border-radius: 2px;
    white-space: nowrap;
    grid-row: span 2;
    align-self: start;
    margin-top: 2px;
  }
  .news-badge.f1   { background: rgba(230,0,0,0.2);   color:#ff6060; border:1px solid rgba(230,0,0,0.4); }
  .news-badge.fe   { background: rgba(180,0,255,0.2);  color:#d070ff; border:1px solid rgba(180,0,255,0.4); }
  .news-badge.indy { background: rgba(255,220,0,0.2);  color:#ffe040; border:1px solid rgba(255,200,0,0.4); }
  .news-badge.moto { background: rgba(0,180,255,0.2);  color:#60d4ff; border:1px solid rgba(0,180,255,0.4); }
  .news-headline {
    font-size: 0.95rem;
    color: var(--text);
    line-height: 1.35;
    font-weight: 400;
  }
  .news-summary {
    grid-column: 2;
    font-size: 0.78rem;
    color: var(--muted);
    line-height: 1.5;
    margin-top: 0.25rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .news-meta {
    font-size: 0.65rem;
    color: var(--muted);
    white-space: nowrap;
    grid-row: span 2;
    align-self: start;
    text-align: right;
    padding-top: 3px;
  }
  .news-loading, .news-error {
    padding: 1.5rem;
    text-align: center;
    font-size: 0.78rem;
    color: var(--muted);
  }
  .news-error { color: #ff6060; }

  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  #globe-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
  }

  /* Banner row above the canvas ‚Äî in normal flow so it pushes canvas down */
  .ad-above-globe {
    flex-shrink: 0;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px 8px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    margin: 0 0 0 0;
  }

  /* Canvas wrapper ‚Äî fills remaining vertical space, canvas absolute inside */
  #canvas-wrapper {
    flex: 1;
    position: relative;
    cursor: grab;
    overflow: hidden;
  }
  #canvas-wrapper:active { cursor: grabbing; }

  canvas {
    position: absolute !important;
    top: 0; left: 0;
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  /* Tooltip ‚Äî simplified */
  #tooltip {
    position: absolute;
    pointer-events: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-left: 2px solid var(--accent);
    padding: 0.75rem 1rem;
    min-width: 200px;
    max-width: 260px;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.2s, transform 0.2s;
    z-index: 50;
  }
  #tooltip.visible { opacity: 1; transform: translateY(0); }
  .tt-region { font-size: 0.56rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.2rem; }
  .tt-city { font-family: 'Fraunces', serif; font-size: 1.05rem; font-weight: 300; margin-bottom: 0.05rem; }
  .tt-country { font-size: 0.58rem; color: var(--muted); margin-bottom: 0.4rem; }
  .tt-time { font-size: 1.1rem; font-weight: 400; color: var(--accent); letter-spacing: 0.02em; font-variant-numeric: tabular-nums; line-height: 1; margin-bottom: 0.15rem; }
  .tt-date { font-size: 0.58rem; color: var(--muted); margin-bottom: 0.4rem; }
  .tt-meta { font-size: 0.56rem; color: var(--muted); display: flex; gap: 0.8rem; border-top: 1px solid var(--border); padding-top: 0.4rem; }

  .phase-dot { display: inline-block; width: 5px; height: 5px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
  .phase-dot.day { background: var(--accent); box-shadow: 0 0 4px var(--accent); }
  .phase-dot.night { background: #4a4a7a; }
  .phase-dot.dawn, .phase-dot.dusk { background: #ff9500; }

  /* ‚îÄ‚îÄ Session panel ‚Äî normal flex item between globe and sidebar ‚îÄ‚îÄ */
  #session-panel {
    width: 0;
    flex-shrink: 0;
    overflow: hidden;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
    z-index: 20;
  }
  #session-panel.open { width: 260px; }
  /* Split panel into scrollable content + fixed footer ad */
  .sp-inner {
    width: 260px;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
  .sp-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.2rem;
    min-height: 0;
  }
  .sp-scroll::-webkit-scrollbar { width: 3px; }
  .sp-scroll::-webkit-scrollbar-thumb { background: var(--border); }
  /* Each dynamically-injected ad block in the session panel */
  .sp-ad-block {
    height: 120px;
    width: 100%;
    margin-top: 1rem;
    flex-shrink: 0;
  }
  .sp-close {
    position: absolute; top: 0.6rem; right: 0.6rem;
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--border); border: none; cursor: pointer;
    color: var(--muted); font-size: 0.7rem; display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
  }
  .sp-close:hover { background: rgba(255,255,255,0.12); }
  .sp-round { font-size: 0.55rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.3rem; }
  .sp-name { font-family: 'Fraunces', serif; font-size: 1.15rem; font-weight: 300; margin-bottom: 0.1rem; line-height: 1.2; }
  .sp-venue { font-size: 0.6rem; color: var(--muted); margin-bottom: 0.6rem; }
  .sp-badges { margin-bottom: 0.8rem; }
  .sp-section-title {
    font-size: 0.52rem; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 0.4rem; padding-top: 0.7rem;
    border-top: 1px solid var(--border);
  }
  .sp-session-row {
    display: flex; justify-content: space-between; align-items: baseline;
    padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.04);
    gap: 0.4rem;
  }
  .sp-series-tag { font-size: 0.5rem; font-weight: 500; letter-spacing: 0.06em; flex-shrink: 0; min-width: 26px; }
  .sp-session-label { font-size: 0.6rem; color: var(--muted); flex-shrink: 0; }
  .sp-session-label.is-race { color: #ff6060; font-weight: 500; }
  .sp-session-time { font-size: 0.65rem; color: var(--text); font-variant-numeric: tabular-nums; text-align: right; }
  .sp-session-time.past { color: var(--muted); text-decoration: line-through; }
  .sp-session-time.upcoming { color: var(--accent); }
  .sp-countdown {
    margin-top: 0.8rem;
    background: rgba(230,0,0,0.08);
    border: 1px solid rgba(230,0,0,0.25);
    border-radius: 3px;
    padding: 0.5rem 0.7rem;
    text-align: center;
  }
  .sp-countdown-label { font-size: 0.5rem; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,100,100,0.6); margin-bottom: 0.2rem; }
  .sp-countdown-value { font-size: 1.1rem; font-weight: 500; color: #ff6060; font-variant-numeric: tabular-nums; }
  .sp-countdown-done { font-size: 0.68rem; color: var(--muted); font-style: italic; }

  /* Sidebar */
  #sidebar-wrap {
    position: relative;
    display: flex;
    flex-shrink: 0;
  }
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.3s;
  }
  .sidebar.collapsed { width: 0 !important; }
  .sidebar-header {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.56rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  /* Series filter buttons */
  .filter-bar {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 0.3rem;
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  .filter-btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.5rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
    background: transparent;
  }
  .filter-btn.all { border-color: rgba(255,255,255,0.2); color: var(--muted); }
  .filter-btn.all.active { background: rgba(255,255,255,0.1); color: var(--text); border-color: rgba(255,255,255,0.3); }
  .filter-btn.f1  { border-color: rgba(230,0,0,0.4);   color: #ff6060; }
  .filter-btn.f2  { border-color: rgba(0,180,255,0.4); color: #60d4ff; }
  .filter-btn.f3  { border-color: rgba(0,220,120,0.4); color: #60ffb0; }
  .filter-btn.f1a { border-color: rgba(255,150,0,0.4); color: #ffb060; }
  .filter-btn.fe  { border-color: rgba(140,0,255,0.4); color: #bb80ff; }
  .filter-btn.indy{ border-color: rgba(255,200,0,0.4); color: #ffe040; }
  .filter-btn.f1.active  { background: rgba(230,0,0,0.2); }
  .filter-btn.f2.active  { background: rgba(0,180,255,0.15); }
  .filter-btn.f3.active  { background: rgba(0,220,120,0.15); }
  .filter-btn.f1a.active { background: rgba(255,150,0,0.15); }
  .filter-btn.fe.active  { background: rgba(140,0,255,0.15); }
  .filter-btn.indy.active{ background: rgba(255,200,0,0.15); }

  .city-list { overflow-y: auto; flex: 1; width: 100%; }
  .city-list::-webkit-scrollbar { width: 3px; }
  .city-list::-webkit-scrollbar-thumb { background: var(--border); }

  .city-item {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto auto;
    gap: 0.05rem 0.6rem;
    transition: background 0.15s;
    position: relative;
  }
  .city-item::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0; width: 2px;
    background: var(--accent);
    opacity: 0;
    transition: opacity 0.15s;
  }
  .city-item:hover { background: var(--surface2); }
  .city-item:hover::before, .city-item.active::before { opacity: 1; }
  .city-item.active { background: var(--surface2); }
  .city-item.hidden { display: none; }

  .ci-name { font-family: 'Fraunces', serif; font-size: 0.9rem; font-weight: 300; grid-column:1; grid-row:1; }
  .ci-country { font-size: 0.56rem; color: var(--muted); grid-column:1; grid-row:2; }
  .ci-time { font-size: 0.72rem; font-weight: 500; color: var(--accent); text-align: right; grid-column:2; grid-row:1; font-variant-numeric: tabular-nums; white-space: nowrap; }
  .ci-date { font-size: 0.56rem; color: var(--muted); text-align: right; grid-column:2; grid-row:2; }

  .series-badges { display: flex; gap: 3px; flex-wrap: wrap; margin-top: 2px; grid-column:1; grid-row:3; }
  .badge {
    font-size: 0.44rem; font-weight: 500; letter-spacing: 0.08em;
    padding: 1px 4px; border-radius: 2px; text-transform: uppercase;
  }
  .badge-f1  { background: rgba(230,0,0,0.25);    color: #ff6060; border: 1px solid rgba(230,0,0,0.4); }
  .badge-f2  { background: rgba(0,180,255,0.2);   color: #60d4ff; border: 1px solid rgba(0,180,255,0.4); }
  .badge-f3  { background: rgba(0,220,120,0.2);   color: #60ffb0; border: 1px solid rgba(0,220,120,0.4); }
  .badge-f1a { background: rgba(255,150,0,0.2);   color: #ffb060; border: 1px solid rgba(255,150,0,0.4); }
  .badge-fe  { background: rgba(100,0,255,0.2);   color: #bb80ff; border: 1px solid rgba(140,0,255,0.4); }
  .badge-indy{ background: rgba(255,220,0,0.2);   color: #ffe040; border: 1px solid rgba(255,200,0,0.4); }
  .badge-fe  { background: rgba(180,0,255,0.2);   color: #d070ff; border: 1px solid rgba(180,0,255,0.4); }
  .badge-indy{ background: rgba(255,220,0,0.2);   color: #ffe040; border: 1px solid rgba(255,220,0,0.4); }

  @keyframes pulse-ring {
    0%   { transform: scale(1);   opacity: 0.9; }
    70%  { transform: scale(2.8); opacity: 0; }
    100% { transform: scale(2.8); opacity: 0; }
  }

  /* Ad placeholder boxes */
  .ad-placeholder {
    background: rgba(220,0,0,0.25);
    border: 2px dashed rgba(255,60,60,0.7);
    color: rgba(255,100,100,0.9);
    font-size: 0.55rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    text-align: center;
  }

  /* Skyscraper ‚Äî tall thin column to the LEFT of globe */
  .ad-skyscraper {
    width: 160px;
    flex-shrink: 0;
    height: 100%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    border-left: 1px solid var(--border);
    padding: 20px;
    box-sizing: border-box;
    background: var(--bg);
  }

  /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
  @media (max-width: 700px) {

    body { overflow: hidden; }

    /* Header ‚Äî compact, single line, no wrapping */
    header {
      padding: 0.5rem 1rem;
      gap: 0.6rem;
      flex-shrink: 0;
      flex-wrap: nowrap;
      overflow-x: hidden;
    }
    h1 { font-size: 1.1rem; }
    .next-race-name { font-size: 0.8rem; }
    .next-race-location { font-size: 0.52rem; }
    .next-race-label { font-size: 0.45rem; }
    .header-countdown-value { font-size: 1rem; }
    .header-countdown-label { font-size: 0.45rem; }
    .hint { display: none; }

    /* Mobile header countdown ‚Äî compact */
    .header-countdown-value { font-size: 0.95rem; }

    /* News toggle bar ‚Äî hide on mobile (news has its own full tab) */
    #news-toggle { display: none; }
    #news-bar    { display: none; }

    /* Main area ‚Äî stack vertically */
    .main { flex-direction: column; overflow: hidden; }

    /* Hide skyscraper and above-globe banner */
    .ad-skyscraper  { display: none; }
    .ad-above-globe { display: none; }

    /* Globe fills available space, padded for fixed bottom bars */
    #globe-container {
      flex: 1;
      min-height: 0;
      padding-bottom: calc(106px + env(safe-area-inset-bottom, 0px));
    }

    /* Hide desktop tooltip on mobile ‚Äî session panel replaces it */
    #tooltip { display: none !important; }

    /* Session panel ‚Äî bottom sheet, 50% height, sits above ad + tabs */
    /* mobile-ad = 50px, mobile-tabs ~56px ‚Üí bottom = 106px */
    #session-panel {
      position: fixed !important;
      left: 0; right: 0;
      bottom: calc(106px + env(safe-area-inset-bottom, 0px)); /* above ad + tabs + safe area */
      width: 100% !important;
      height: 0;
      max-height: 33vh;
      flex-direction: column;
      border-left: none;
      border-top: 1px solid var(--border);
      border-radius: 12px 12px 0 0;
      transition: height 0.3s ease !important;
      z-index: 180;        /* below tab bar z-index */
    }
    #session-panel.open {
      width: 100% !important;
      height: 33vh;
    }
    .sp-inner { width: 100%; }

    /* Sidebar ‚Äî hidden on mobile (including the wrap + toggle button) */
    .sidebar { display: none; }
    #sidebar-wrap { display: none; }

    /* Header ‚Äî no horizontal scroll on mobile, just clip */
    header { overflow-x: hidden; }

    /* Mobile tab bar */
    #mobile-tabs {
      position: fixed;
      bottom: 0;
      left: 0; right: 0;
      display: flex;
      flex-shrink: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 200;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* Mobile ad banner */
    #mobile-ad {
      position: fixed;
      bottom: calc(56px + env(safe-area-inset-bottom, 0px));
      left: 0; right: 0;
      display: flex;
      flex-shrink: 0;
      height: 50px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      z-index: 200;
    }
    #mobile-ad .ad-placeholder {
      flex: 1; height: 100%;
      border-radius: 0; border: none;
      font-size: 0.5rem;
    }

    /* Race list overlay */
    #mobile-race-list {
      position: fixed;
      left: 0; right: 0;
      bottom: calc(106px + env(safe-area-inset-bottom, 0px));
      background: var(--surface);
      z-index: 150;
      flex-direction: column;
      overflow: hidden;
      display: none;
    }
    #mobile-race-list.visible { display: flex; }

    /* Full-screen news overlay for mobile news tab */
    #mobile-news {
      position: fixed;
      left: 0; right: 0;
      bottom: calc(106px + env(safe-area-inset-bottom, 0px));
      background: var(--surface);
      z-index: 150;
      flex-direction: column;
      overflow: hidden;
      display: none;
    }
    #mobile-news.visible { display: flex; }
    #mobile-news .news-item { padding: 0.9rem 1rem; }
    #mobile-news #news-list-mobile {
      flex: 1;
      overflow-y: auto;
      padding: 0.4rem 0;
    }
    #mobile-news #news-list-mobile::-webkit-scrollbar { width: 3px; }
    #mobile-news #news-list-mobile::-webkit-scrollbar-thumb { background: var(--border); }
    #mobile-news .mob-news-header {
      padding: 0.7rem 1rem;
      font-size: 0.55rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    /* Mobile news filter buttons */
    .mob-news-filter {
      font-family: 'DM Mono', monospace;
      font-size: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 3px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .mob-news-filter.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    /* Globe centering ‚Äî pad bottom by session panel height when open */
    #globe-container { transition: padding-bottom 0.3s ease; }
    #session-panel.open ~ * { /* handled by JS nudging camera */ }

    /* Hide FE and IndyCar header blocks on mobile */
    .hdr-fe-indy { display: none; }
  }

  /* Desktop only ‚Äî hide mobile-only elements */
  @media (min-width: 701px) {
    #mobile-tabs     { display: none; }
    #mobile-ad       { display: none; }
    #mobile-race-list { display: none; }
    #mobile-news     { display: none; }
  }

  .mob-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    padding: 0.5rem 0.3rem;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.45rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: color 0.15s, background 0.15s;
  }
  .mob-tab:active { background: var(--surface2); }
  .mob-tab.active { color: var(--accent); }
  /* ‚îÄ‚îÄ TABLET / iPad ‚îÄ‚îÄ */
  @media (min-width: 701px) and (max-width: 1024px) {
    /* Header ‚Äî compact for tablet */
    header { padding: 0.45rem 0.9rem; gap: 0.6rem; }
    h1 { font-size: 1.05rem; }
    .next-race-name { font-size: 0.75rem; }
    .next-race-location { font-size: 0.46rem; }
    .next-race-label { font-size: 0.42rem; }
    .header-countdown-value { font-size: 0.9rem; }
    .header-countdown-label { font-size: 0.42rem; }
    .hint { display: none; }

    /* Sidebar narrower */
    .sidebar { width: 210px; }
    #session-panel.open { width: 210px; }
    .sp-inner { width: 210px; }
    .sp-scroll { padding: 0.8rem 1rem; }
    .sp-name { font-size: 1.05rem; }

    /* Hide skyscraper ‚Äî not enough room on tablet */
    .ad-skyscraper { display: none; }

    /* News */
    #news-toggle { font-size: 0.52rem; height: 30px; }
    .ticker-item { font-size: 0.7rem; }
    .news-headline { font-size: 0.78rem; }
    .news-summary  { font-size: 0.65rem; }
    #news-filter-bar { padding: 0.4rem 0.8rem; gap: 0.35rem; }
    .news-filter-btn { font-size: 0.48rem; padding: 2px 8px; }
  }

  /* ‚îÄ‚îÄ Sidebar collapse toggle (desktop) ‚îÄ‚îÄ */
  #sidebar-collapse-btn {
    position: absolute;
    top: 50%;
    left: -20px;
    transform: translateY(-50%);
    width: 40px; height: 40px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--text);
    font-size: 0.85rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    z-index: 200;
    transition: background 0.15s, color 0.15s, left 0.3s;
    flex-shrink: 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  #sidebar-collapse-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }
  .sidebar.collapsed #sidebar-collapse-btn { left: -20px; }
  .sidebar { overflow: visible; }
  .sidebar.collapsed { width: 0 !important; }
</style>
</head>
<body>

<header>
  <div>
    <h1>Grid<em>Pulse</em></h1>
  </div>
  <div class="header-divider"></div>

  <!-- F1 next race -->
  <div class="hdr-race-block" id="hdr-f1-block">
    <div class="next-race-label" style="color:rgba(255,96,96,0.7)">üèé Next F1</div>
    <div class="next-race-name" id="hdr-f1-name">‚Äî</div>
    <div class="next-race-location" id="hdr-f1-loc">‚Äî</div>
  </div>
  <div class="header-countdown">
    <div class="header-countdown-label" style="color:rgba(255,96,96,0.7)">Starts in</div>
    <div class="header-countdown-value" id="hdr-f1-countdown" style="color:#ff6060">--:--:--</div>
  </div>

  <div class="header-divider"></div>

  <!-- Formula E next race -->
  <div class="hdr-race-block hdr-fe-indy" id="hdr-fe-block">
    <div class="next-race-label" style="color:rgba(187,128,255,0.7)">‚ö° Next Formula E</div>
    <div class="next-race-name" id="hdr-fe-name">‚Äî</div>
    <div class="next-race-location" id="hdr-fe-loc">‚Äî</div>
  </div>
  <div class="header-countdown hdr-fe-indy" id="hdr-fe-countdown-wrap">
    <div class="header-countdown-label" style="color:rgba(187,128,255,0.7)">Starts in</div>
    <div class="header-countdown-value" id="hdr-fe-countdown" style="color:#bb80ff">--:--:--</div>
  </div>

  <div class="header-divider hdr-fe-indy"></div>

  <!-- IndyCar next race -->
  <div class="hdr-race-block hdr-fe-indy" id="hdr-indy-block">
    <div class="next-race-label" style="color:rgba(255,224,64,0.7)">üèÅ Next IndyCar</div>
    <div class="next-race-name" id="hdr-indy-name">‚Äî</div>
    <div class="next-race-location" id="hdr-indy-loc">‚Äî</div>
  </div>
  <div class="header-countdown hdr-fe-indy" id="hdr-indy-countdown-wrap">
    <div class="header-countdown-label" style="color:rgba(255,224,64,0.7)">Starts in</div>
    <div class="header-countdown-value" id="hdr-indy-countdown" style="color:#ffe040">--:--:--</div>
  </div>

  <div class="header-divider hdr-fe-indy"></div>
  <span class="hint">Drag ¬∑ Scroll to zoom</span>
</header>

<!-- News toggle button ‚Äî always visible, contains ticker when closed -->
<div id="news-toggle">
  <span class="nt-dot"></span>
  <span class="nt-label">News</span>
  <span class="nt-divider"></span>
  <!-- Filter buttons in ticker bar -->
  <div id="news-filter-bar">
    <span class="news-filter-btn active" data-filter="all">All</span>
    <span class="news-filter-btn" data-filter="f1">F1</span>
    <span class="news-filter-btn" data-filter="other">Other</span>
  </div>
  <span class="nt-divider"></span>
  <!-- Ticker scrolls when dropdown is closed -->
  <div id="news-ticker-wrap">
    <div id="news-ticker">
      <span style="color:var(--muted);font-size:0.65rem;letter-spacing:0.05em">Loading news‚Ä¶</span>
    </div>
  </div>
  <span id="news-count" style="color:var(--muted);font-size:0.52rem;white-space:nowrap;flex-shrink:0"></span>
  <span class="nt-arrow">‚ñº</span>
</div>

<!-- News bar ‚Äî collapsible, shows top 3 stories -->
<div id="news-bar">
  <div id="news-list"></div>
</div>

<!-- AD SLOT 3 ‚Äî Below-header leaderboard (728√ó90) REMOVED -->

<div class="main">

  <!-- AD SLOT ‚Äî Skyscraper to the LEFT of globe (160√ó600) -->
  <div class="ad-skyscraper">
    <div class="ad-placeholder" style="flex:1;width:100%">
      üì¢ Ad<br>160√ó600<br>Skyscraper
    </div>
  </div>

  <div id="globe-container">

    <!-- AD SLOT ‚Äî Above globe, centred (728√ó90) -->
    <div class="ad-above-globe">
      <div class="ad-placeholder" style="width:min(728px,100%);height:100%;border-radius:3px">
        üì¢ Ad ‚Äî 728√ó90 (Above Globe)
      </div>
    </div>

    <!-- Canvas wrapper ‚Äî fills remaining space, canvas is absolute inside here -->
    <div id="canvas-wrapper">
      <div id="tooltip">
        <div class="tt-region" id="tt-region"></div>
        <div class="tt-city" id="tt-city"></div>
        <div class="tt-country" id="tt-country"></div>
        <div class="series-badges" id="tt-badges" style="margin-bottom:0.4rem;"></div>
        <div class="tt-time" id="tt-time"></div>
        <div class="tt-date" id="tt-date"></div>
        <div class="tt-meta">
          <span><span class="phase-dot" id="tt-phase-dot"></span><span id="tt-phase"></span></span>
          <span id="tt-offset"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Session panel ‚Äî flex sibling between globe and sidebar.
       width:0 when closed, 260px when open. Globe shrinks naturally. -->
  <div id="session-panel">
    <div class="sp-inner" id="sp-inner">
      <div class="sp-scroll" id="sp-scroll">
        <div style="position:relative; min-height:24px;">
          <button class="sp-close" id="sp-close" title="Close">‚úï</button>
        </div>
        <div class="sp-round" id="sp-round"></div>
        <div class="sp-name" id="sp-name"></div>
        <div class="sp-venue" id="sp-venue"></div>
        <div class="sp-badges" id="sp-badges"></div>
        <div id="sp-sessions"></div>
        <div class="sp-countdown" id="sp-countdown">
          <div class="sp-countdown-label">üèÅ F1 Race starts in</div>
          <div class="sp-countdown-value" id="sp-countdown-value">‚Äî</div>
        </div>
        <div id="sp-ads"></div>
      </div>
    </div>
  </div>

  <div id="sidebar-wrap">
  <button id="sidebar-collapse-btn" title="Toggle race list">‚óÄ</button>
  <div class="sidebar">
    <div class="sidebar-header">
      <span>2026 Calendar</span>
      <span id="sidebar-count" style="color:var(--accent)">0</span>
    </div>
    <div class="filter-bar" id="filter-bar">
      <button class="filter-btn all active" data-filter="all">All</button>
      <button class="filter-btn f1" data-filter="f1">F1</button>
      <button class="filter-btn f2" data-filter="f2">F2</button>
      <button class="filter-btn f3" data-filter="f3">F3</button>
      <button class="filter-btn f1a" data-filter="f1a">F1 Academy</button>
      <button class="filter-btn fe" data-filter="fe">Formula E</button>
      <button class="filter-btn indy" data-filter="indy">IndyCar</button>
    </div>
    <div class="city-list" id="city-list"></div>
  </div>
</div>

</div>

<!-- Mobile: horizontal ad banner above tabs -->
<div id="mobile-ad">
  <div class="ad-placeholder">üì¢ Ad ‚Äî 320√ó50 Mobile Banner</div>
</div>

<!-- Mobile: tab bar at bottom -->
<div id="mobile-tabs">
  <button class="mob-tab active" id="tab-globe" onclick="mobileTab('globe')">
    <span class="mob-tab-icon">üåç</span>Globe
  </button>
  <button class="mob-tab" id="tab-list" onclick="mobileTab('list')">
    <span class="mob-tab-icon">üìÖ</span>Calendar
  </button>
  <button class="mob-tab" id="tab-news" onclick="mobileTab('news')">
    <span class="mob-tab-icon">üì∞</span>News
  </button>
</div>

<!-- Mobile: full-screen news overlay (News tab) -->
<div id="mobile-news">
  <div class="mob-news-header">
    <span style="width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);flex-shrink:0"></span>
    Motorsport News
    <span id="mob-news-count" style="color:var(--accent);margin-left:0.2rem"></span>
  </div>
  <div id="mob-news-filters" style="display:flex;gap:0.4rem;padding:0.5rem 1rem;border-bottom:1px solid var(--border);flex-shrink:0;">
    <button class="mob-news-filter active" data-filter="all">All</button>
    <button class="mob-news-filter" data-filter="f1">F1</button>
    <button class="mob-news-filter" data-filter="other">Other</button>
  </div>
  <div id="news-list-mobile">
    <div class="news-loading">Loading news‚Ä¶</div>
  </div>
</div>

<!-- Mobile: full-screen race list overlay (Calendar tab) -->
<div id="mobile-race-list"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
window.onerror = function(msg, src, line, col, err) {
  document.body.style.background = '#1a0000';
  var d = document.createElement('div');
  d.style.cssText = 'position:fixed;top:20px;left:20px;right:20px;padding:20px;background:#300;color:#f88;font-family:monospace;font-size:13px;z-index:99999;border-radius:8px;white-space:pre-wrap;border:1px solid #f44';
  d.textContent = 'JS ERROR:\n' + msg + '\nLine: ' + line + '\nFile: ' + src + '\n\n' + (err && err.stack ? err.stack : '');
  document.body.appendChild(d);
  return true;
};
window.addEventListener('unhandledrejection', function(e) {
  window.onerror('Unhandled Promise: ' + e.reason, '', 0, 0, e.reason);
});

// F1 2026 Season ‚Äî 24 rounds with all series session times (UTC ISO strings)
// F1 sessions confirmed from The Race; F2/F3 from official FIA sites; F1A from f1academy.com
// Support series times are based on confirmed Melbourne slots + standard weekend patterns
// ‚îÄ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const isMobile = () => window.innerWidth <= 700;
const isTablet = () => window.innerWidth > 700 && window.innerWidth <= 1024;

const cities = [
  // R1 Australia (F1+F2+F3) ‚Äì confirmed from gpblog.com official schedule
  { city: 'Albert Park', country: 'Australia', region: 'Australian GP', round:1, series:['f1','f2','f3'], tz:'Australia/Melbourne', lat:-37.84, lng:144.97,
    sessions:{ fp1:'2026-03-06T01:30Z', fp2:'2026-03-06T05:00Z', fp3:'2026-03-07T02:30Z', quali:'2026-03-07T05:00Z', race:'2026-03-08T04:00Z' },
    f3Sessions:{ fp:'2026-03-05T21:50Z', quali:'2026-03-06T03:00Z', sprint:'2026-03-07T00:15Z', feature:'2026-03-07T22:05Z' },
    f2Sessions:{ fp:'2026-03-05T23:00Z', quali:'2026-03-06T03:55Z', sprint:'2026-03-07T03:10Z', feature:'2026-03-08T00:25Z' } },

  // R2 China Sprint (F1+F1A) ‚Äì F1A times TBC, using standard Friday/Sat/Sun slots CST(UTC+8)
  { city: 'Shanghai Int\'l Circuit', country: 'China', region: 'Chinese GP', round:2, series:['f1','f1a'], tz:'Asia/Shanghai', lat:31.34, lng:121.22,
    sessions:{ fp1:'2026-03-13T03:30Z', sq:'2026-03-13T07:30Z', sprint:'2026-03-14T03:00Z', quali:'2026-03-14T07:00Z', race:'2026-03-15T07:00Z' },
    f1aSessions:{ quali:'2026-03-13T09:00Z', race1:'2026-03-14T01:30Z', race2:'2026-03-15T00:00Z' } },

  // R3 Japan (F1 only)
  { city: 'Suzuka Circuit', country: 'Japan', region: 'Japanese GP', round:3, series:['f1'], tz:'Asia/Tokyo', lat:34.84, lng:136.54,
    sessions:{ fp1:'2026-03-27T02:30Z', fp2:'2026-03-27T06:00Z', fp3:'2026-03-28T03:00Z', quali:'2026-03-28T07:00Z', race:'2026-03-29T05:00Z' } },

  // R4 Bahrain (F1+F2+F3) ‚Äì evening races, local times AST(UTC+3)
  { city: 'Bahrain Int\'l Circuit', country: 'Bahrain', region: 'Bahrain GP', round:4, series:['f1','f2','f3'], tz:'Asia/Bahrain', lat:26.03, lng:50.51,
    sessions:{ fp1:'2026-04-10T09:30Z', fp2:'2026-04-10T13:00Z', fp3:'2026-04-11T10:30Z', quali:'2026-04-11T14:00Z', race:'2026-04-12T15:00Z' },
    f3Sessions:{ fp:'2026-04-10T07:00Z', quali:'2026-04-10T11:30Z', sprint:'2026-04-11T08:30Z', feature:'2026-04-12T07:30Z' },
    f2Sessions:{ fp:'2026-04-10T08:00Z', quali:'2026-04-10T12:30Z', sprint:'2026-04-11T11:30Z', feature:'2026-04-12T09:30Z' } },

  // R5 Saudi (F1+F2+F1A) ‚Äì night race, AST(UTC+3)
  { city: 'Jeddah Corniche Circuit', country: 'Saudi Arabia', region: 'Saudi Arabian GP', round:5, series:['f1','f2','f1a'], tz:'Asia/Riyadh', lat:21.63, lng:39.10,
    sessions:{ fp1:'2026-04-17T15:00Z', fp2:'2026-04-17T18:30Z', fp3:'2026-04-18T16:30Z', quali:'2026-04-18T17:00Z', race:'2026-04-19T17:00Z' },
    f2Sessions:{ fp:'2026-04-17T12:00Z', quali:'2026-04-17T15:30Z', sprint:'2026-04-18T12:30Z', feature:'2026-04-19T11:30Z' },
    f1aSessions:{ quali:'2026-04-17T17:00Z', race1:'2026-04-18T14:30Z', race2:'2026-04-19T13:00Z' } },

  // R6 Miami Sprint (F1 only)
  { city: 'Miami Int\'l Autodrome', country: 'USA', region: 'Miami GP', round:6, series:['f1'], tz:'America/New_York', lat:25.96, lng:-80.24,
    sessions:{ fp1:'2026-05-01T16:30Z', sq:'2026-05-01T20:30Z', sprint:'2026-05-02T15:30Z', quali:'2026-05-02T19:00Z', race:'2026-05-03T20:00Z' } },

  // R7 Canada Sprint (F1+F1A) ‚Äì EDT(UTC-4)
  { city: 'Circuit Gilles Villeneuve', country: 'Canada', region: 'Canadian GP', round:7, series:['f1','f1a'], tz:'America/Toronto', lat:45.50, lng:-73.52,
    sessions:{ fp1:'2026-05-22T17:30Z', sq:'2026-05-22T21:30Z', sprint:'2026-05-23T16:30Z', quali:'2026-05-23T20:00Z', race:'2026-05-24T20:00Z' },
    f1aSessions:{ quali:'2026-05-22T22:30Z', race1:'2026-05-23T14:00Z', race2:'2026-05-24T13:00Z' } },

  // R8 Monaco (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Circuit de Monaco', country: 'Monaco', region: 'Monaco GP', round:8, series:['f1','f2','f3'], tz:'Europe/Monaco', lat:43.74, lng:7.43,
    sessions:{ fp1:'2026-06-05T11:30Z', fp2:'2026-06-05T15:00Z', fp3:'2026-06-06T10:30Z', quali:'2026-06-06T13:00Z', race:'2026-06-07T13:00Z' },
    f3Sessions:{ fp:'2026-06-05T09:00Z', quali:'2026-06-05T13:00Z', sprint:'2026-06-06T08:30Z', feature:'2026-06-07T07:30Z' },
    f2Sessions:{ fp:'2026-06-05T10:00Z', quali:'2026-06-05T14:00Z', sprint:'2026-06-06T11:00Z', feature:'2026-06-07T09:30Z' } },

  // R9 Barcelona (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Circuit de Barcelona-Catalunya', country: 'Spain', region: 'Spanish GP', round:9, series:['f1','f2','f3'], tz:'Europe/Madrid', lat:41.57, lng:2.26,
    sessions:{ fp1:'2026-06-12T11:30Z', fp2:'2026-06-12T15:00Z', fp3:'2026-06-13T10:30Z', quali:'2026-06-13T13:00Z', race:'2026-06-14T13:00Z' },
    f3Sessions:{ fp:'2026-06-12T09:00Z', quali:'2026-06-12T13:00Z', sprint:'2026-06-13T08:45Z', feature:'2026-06-14T07:30Z' },
    f2Sessions:{ fp:'2026-06-12T10:00Z', quali:'2026-06-12T14:00Z', sprint:'2026-06-13T11:00Z', feature:'2026-06-14T09:30Z' } },

  // R10 Austria (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Red Bull Ring', country: 'Austria', region: 'Austrian GP', round:10, series:['f1','f2','f3'], tz:'Europe/Vienna', lat:47.22, lng:14.76,
    sessions:{ fp1:'2026-06-26T11:30Z', fp2:'2026-06-26T15:00Z', fp3:'2026-06-27T10:30Z', quali:'2026-06-27T13:00Z', race:'2026-06-28T13:00Z' },
    f3Sessions:{ fp:'2026-06-26T09:00Z', quali:'2026-06-26T13:00Z', sprint:'2026-06-27T08:45Z', feature:'2026-06-28T07:30Z' },
    f2Sessions:{ fp:'2026-06-26T10:00Z', quali:'2026-06-26T14:00Z', sprint:'2026-06-27T11:00Z', feature:'2026-06-28T09:30Z' } },

  // R11 Britain Sprint (F1+F2+F3+F1A) ‚Äì BST(UTC+1)
  { city: 'Silverstone Circuit', country: 'United Kingdom', region: 'British GP', round:11, series:['f1','f2','f3','f1a'], tz:'Europe/London', lat:52.07, lng:-1.02,
    sessions:{ fp1:'2026-07-03T10:30Z', sq:'2026-07-03T14:30Z', sprint:'2026-07-04T11:00Z', quali:'2026-07-04T14:00Z', race:'2026-07-05T14:00Z' },
    f3Sessions:{ fp:'2026-07-03T08:30Z', quali:'2026-07-03T13:00Z', sprint:'2026-07-04T08:30Z', feature:'2026-07-05T08:30Z' },
    f2Sessions:{ fp:'2026-07-03T09:30Z', quali:'2026-07-03T14:00Z', sprint:'2026-07-04T09:45Z', feature:'2026-07-05T10:00Z' },
    f1aSessions:{ quali:'2026-07-03T15:30Z', race1:'2026-07-04T07:30Z', race2:'2026-07-05T07:00Z' } },

  // R12 Belgium (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Circuit de Spa-Francorchamps', country: 'Belgium', region: 'Belgian GP', round:12, series:['f1','f2','f3'], tz:'Europe/Brussels', lat:50.44, lng:5.97,
    sessions:{ fp1:'2026-07-17T11:30Z', fp2:'2026-07-17T15:00Z', fp3:'2026-07-18T10:30Z', quali:'2026-07-18T13:00Z', race:'2026-07-19T13:00Z' },
    f3Sessions:{ fp:'2026-07-17T09:00Z', quali:'2026-07-17T13:00Z', sprint:'2026-07-18T08:45Z', feature:'2026-07-19T07:30Z' },
    f2Sessions:{ fp:'2026-07-17T10:00Z', quali:'2026-07-17T14:00Z', sprint:'2026-07-18T11:00Z', feature:'2026-07-19T09:30Z' } },

  // R13 Hungary (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Hungaroring', country: 'Hungary', region: 'Hungarian GP', round:13, series:['f1','f2','f3'], tz:'Europe/Budapest', lat:47.58, lng:19.25,
    sessions:{ fp1:'2026-07-24T11:30Z', fp2:'2026-07-24T15:00Z', fp3:'2026-07-25T10:30Z', quali:'2026-07-25T13:00Z', race:'2026-07-26T13:00Z' },
    f3Sessions:{ fp:'2026-07-24T09:00Z', quali:'2026-07-24T13:00Z', sprint:'2026-07-25T08:45Z', feature:'2026-07-26T07:30Z' },
    f2Sessions:{ fp:'2026-07-24T10:00Z', quali:'2026-07-24T14:00Z', sprint:'2026-07-25T11:00Z', feature:'2026-07-26T09:30Z' } },

  // R14 Netherlands Sprint (F1+F1A) ‚Äì CEST(UTC+2)
  { city: 'Circuit Zandvoort', country: 'Netherlands', region: 'Dutch GP', round:14, series:['f1','f1a'], tz:'Europe/Amsterdam', lat:52.39, lng:4.54,
    sessions:{ fp1:'2026-08-21T10:30Z', sq:'2026-08-21T14:30Z', sprint:'2026-08-22T11:00Z', quali:'2026-08-22T14:00Z', race:'2026-08-23T13:00Z' },
    f1aSessions:{ quali:'2026-08-21T15:30Z', race1:'2026-08-22T07:30Z', race2:'2026-08-23T07:30Z' } },

  // R15 Italy (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Autodromo Nazionale Monza', country: 'Italy', region: 'Italian GP', round:15, series:['f1','f2','f3'], tz:'Europe/Rome', lat:45.62, lng:9.28,
    sessions:{ fp1:'2026-09-04T11:30Z', fp2:'2026-09-04T15:00Z', fp3:'2026-09-05T10:30Z', quali:'2026-09-05T13:00Z', race:'2026-09-06T13:00Z' },
    f3Sessions:{ fp:'2026-09-04T09:00Z', quali:'2026-09-04T13:00Z', sprint:'2026-09-05T08:45Z', feature:'2026-09-06T07:30Z' },
    f2Sessions:{ fp:'2026-09-04T10:00Z', quali:'2026-09-04T14:00Z', sprint:'2026-09-05T11:00Z', feature:'2026-09-06T09:30Z' } },

  // R16 Madrid (F1+F2+F3) ‚Äì CEST(UTC+2)
  { city: 'Madrid Street Circuit (IFEMA)', country: 'Spain', region: 'Spanish GP (Madrid)', round:16, series:['f1','f2','f3'], tz:'Europe/Madrid', lat:40.47, lng:-3.69,
    sessions:{ fp1:'2026-09-11T11:30Z', fp2:'2026-09-11T15:00Z', fp3:'2026-09-12T10:30Z', quali:'2026-09-12T13:00Z', race:'2026-09-13T13:00Z' },
    f3Sessions:{ fp:'2026-09-11T09:00Z', quali:'2026-09-11T13:00Z', sprint:'2026-09-12T08:45Z', feature:'2026-09-13T07:30Z' },
    f2Sessions:{ fp:'2026-09-11T10:00Z', quali:'2026-09-11T14:00Z', sprint:'2026-09-12T11:00Z', feature:'2026-09-13T09:30Z' } },

  // R17 Baku SAT race (F1+F2) ‚Äì AZT(UTC+4)
  { city: 'Baku City Circuit', country: 'Azerbaijan', region: 'Azerbaijan GP', round:17, series:['f1','f2'], tz:'Asia/Baku', lat:40.37, lng:49.85,
    sessions:{ fp1:'2026-09-25T09:00Z', fp2:'2026-09-25T12:30Z', quali:'2026-09-25T10:00Z', race:'2026-09-26T11:00Z' },
    f2Sessions:{ fp:'2026-09-24T07:00Z', quali:'2026-09-24T11:30Z', sprint:'2026-09-25T07:30Z', feature:'2026-09-26T07:30Z' } },

  // R18 Singapore Sprint (F1 only)
  { city: 'Marina Bay Circuit', country: 'Singapore', region: 'Singapore GP', round:18, series:['f1'], tz:'Asia/Singapore', lat:1.29, lng:103.86,
    sessions:{ fp1:'2026-10-09T09:30Z', sq:'2026-10-09T13:30Z', sprint:'2026-10-10T10:00Z', quali:'2026-10-10T13:00Z', race:'2026-10-11T12:00Z' } },

  // R19 USA (F1+F1A) ‚Äì CDT(UTC-5)
  { city: 'Circuit of the Americas', country: 'USA', region: 'US GP', round:19, series:['f1','f1a'], tz:'America/Chicago', lat:30.13, lng:-97.64,
    sessions:{ fp1:'2026-10-23T16:30Z', fp2:'2026-10-23T20:00Z', fp3:'2026-10-24T16:30Z', quali:'2026-10-24T20:00Z', race:'2026-10-25T20:00Z' },
    f1aSessions:{ quali:'2026-10-23T22:00Z', race1:'2026-10-24T14:00Z', race2:'2026-10-25T13:30Z' } },

  // R20 Mexico (F1 only)
  { city: 'Autodromo Hermanos Rodriguez', country: 'Mexico', region: 'Mexico City GP', round:20, series:['f1','fe'], tz:'America/Mexico_City', lat:19.40, lng:-99.09,
    sessions:{ fp1:'2026-10-30T17:30Z', fp2:'2026-10-30T21:00Z', fp3:'2026-10-31T17:30Z', quali:'2026-10-31T21:00Z', race:'2026-11-01T20:00Z' } },

  // R21 Brazil (F1 only)
  { city: 'Autodromo Jose Carlos Pace', country: 'Brazil', region: 'S√£o Paulo GP', round:21, series:['f1'], tz:'America/Sao_Paulo', lat:-23.70, lng:-46.70,
    sessions:{ fp1:'2026-11-06T14:30Z', fp2:'2026-11-06T18:00Z', fp3:'2026-11-07T14:30Z', quali:'2026-11-07T18:00Z', race:'2026-11-08T17:00Z' } },

  // R22 Las Vegas SAT race (F1+F1A) ‚Äì PST(UTC-8)
  { city: 'Las Vegas Strip Circuit', country: 'USA', region: 'Las Vegas GP', round:22, series:['f1','f1a'], tz:'America/Los_Angeles', lat:36.11, lng:-115.17,
    sessions:{ fp1:'2026-11-20T07:00Z', fp2:'2026-11-20T11:00Z', quali:'2026-11-21T06:00Z', race:'2026-11-22T04:00Z' },
    f1aSessions:{ quali:'2026-11-20T13:00Z', race1:'2026-11-21T03:30Z', race2:'2026-11-22T02:00Z' } },

  // R23 Qatar (F1+F2) ‚Äì AST(UTC+3)
  { city: 'Lusail Circuit', country: 'Qatar', region: 'Qatar GP', round:23, series:['f1','f2'], tz:'Asia/Qatar', lat:25.49, lng:51.45,
    sessions:{ fp1:'2026-11-27T12:30Z', fp2:'2026-11-27T16:00Z', fp3:'2026-11-28T12:30Z', quali:'2026-11-28T15:00Z', race:'2026-11-29T16:00Z' },
    f2Sessions:{ fp:'2026-11-27T10:00Z', quali:'2026-11-27T13:30Z', sprint:'2026-11-28T10:00Z', feature:'2026-11-29T11:30Z' } },

  // R24 Abu Dhabi (F1+F2) ‚Äì GST(UTC+4)
  { city: 'Yas Marina Circuit', country: 'UAE', region: 'Abu Dhabi GP', round:24, series:['f1','f2'], tz:'Asia/Dubai', lat:24.47, lng:54.60,
    sessions:{ fp1:'2026-12-04T10:30Z', fp2:'2026-12-04T14:00Z', fp3:'2026-12-05T10:30Z', quali:'2026-12-05T12:00Z', race:'2026-12-06T13:00Z' },
    f2Sessions:{ fp:'2026-12-04T08:00Z', quali:'2026-12-04T11:30Z', sprint:'2026-12-05T08:00Z', feature:'2026-12-06T09:30Z' } },

  // ‚îÄ‚îÄ FORMULA E 2025/26 SEASON 12 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Venues not shared with F1. FE race UTC times from fiaformulae.com / e-formula.news
  // Standard FE race start: ~14:00-15:00 local. Using confirmed times where available.
  // Jeddah, Monaco, Miami, Mexico City, Shanghai are shared with F1 entries above.

  // R1 FE S√£o Paulo ‚Äì 6 Dec 2025 ~14:00 BRT (UTC-3) = 17:00Z
  { city: 'Sambadrome', country: 'Brazil', region: 'S√£o Paulo E-Prix', round:'FE-1', series:['fe'], tz:'America/Sao_Paulo', lat:-23.49, lng:-46.63,
    sessions:{ race:'2025-12-06T17:00Z' } },

  // R3 FE Miami ‚Äì 31 Jan 2026 ~14:00 EST (UTC-5) = 19:00Z  (Miami Int'l Autodrome ‚Äî shared venue with F1 R6)
  // Already added 'fe' to Miami F1 entry above. No separate dot needed.

  // R4+5 FE Jeddah ‚Äì 13-14 Feb 2026 20:05 AST (UTC+3) = 17:05Z confirmed
  // Already added 'fe' to Jeddah F1 entry above.

  // R6 FE Madrid/Jarama ‚Äì 21 Mar 2026 ~14:00 CET (UTC+1) = 13:00Z
  { city: 'Circuito de Madrid-Jarama', country: 'Spain', region: 'Madrid E-Prix', round:'FE-6', series:['fe'], tz:'Europe/Madrid', lat:40.62, lng:-3.59,
    sessions:{ race:'2026-03-21T13:00Z' } },

  // R7+8 FE Berlin ‚Äì 2-3 May 2026 ~14:00 CEST (UTC+2) = 12:00Z
  { city: 'Tempelhof Airport', country: 'Germany', region: 'Berlin E-Prix', round:'FE-7', series:['fe'], tz:'Europe/Berlin', lat:52.47, lng:13.40,
    sessions:{ race:'2026-05-02T12:00Z', race2:'2026-05-03T12:00Z' } },

  // R9+10 FE Monaco ‚Äì 16-17 May 2026  (shared with F1 R8 ‚Äî already added 'fe')

  // R11 FE Sanya ‚Äì 20 Jun 2026 ~14:00 CST (UTC+8) = 06:00Z
  { city: 'Sanya Street Circuit', country: 'China', region: 'Sanya E-Prix', round:'FE-11', series:['fe'], tz:'Asia/Shanghai', lat:18.26, lng:109.51,
    sessions:{ race:'2026-06-20T06:00Z' } },

  // R12+13 FE Shanghai ‚Äì 4-5 Jul 2026  (shared with F1 R2 ‚Äî already added 'fe')

  // R14+15 FE Tokyo ‚Äì 25-26 Jul 2026 ~14:00 JST (UTC+9) = 05:00Z
  { city: 'Tokyo Street Circuit', country: 'Japan', region: 'Tokyo E-Prix', round:'FE-14', series:['fe'], tz:'Asia/Tokyo', lat:35.67, lng:139.77,
    sessions:{ race:'2026-07-25T05:00Z', race2:'2026-07-26T05:00Z' } },

  // R16+17 FE London ‚Äì 15-16 Aug 2026 ~15:00 BST (UTC+1) = 14:00Z
  { city: 'ExCeL London', country: 'United Kingdom', region: 'London E-Prix', round:'FE-16', series:['fe'], tz:'Europe/London', lat:51.51, lng:0.03,
    sessions:{ race:'2026-08-15T14:00Z', race2:'2026-08-16T14:00Z' } },

  // ‚îÄ‚îÄ INDYCAR 2026 SEASON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // 18 races. Race UTC times from indycar.com official schedule (ET broadcast times).
  // ET = UTC-5 (standard) or UTC-4 (daylight). US DST starts Mar 8, ends Nov 1.

  // R1 St. Petersburg ‚Äì Sun 1 Mar, 12:00 ET (EST UTC-5) = 17:00Z
  { city: 'Streets of St. Petersburg', country: 'USA', region: 'Grand Prix of St. Petersburg', round:'IC-1', series:['indy'], tz:'America/New_York', lat:27.77, lng:-82.64,
    sessions:{ race:'2026-03-01T17:00Z' } },

  // R2 Phoenix ‚Äì Sat 7 Mar, 15:00 ET (MST UTC-7, no DST) = 22:00Z
  { city: 'Phoenix Raceway', country: 'USA', region: 'Grand Prix of Phoenix', round:'IC-2', series:['indy'], tz:'America/Phoenix', lat:33.37, lng:-112.31,
    sessions:{ race:'2026-03-07T22:00Z' } },

  // R3 Arlington ‚Äì Sun 15 Mar, 12:30 ET (CDT UTC-5 after DST Mar 8) = 17:30Z
  { city: 'Streets of Arlington', country: 'USA', region: 'Grand Prix of Arlington', round:'IC-3', series:['indy'], tz:'America/Chicago', lat:32.75, lng:-97.09,
    sessions:{ race:'2026-03-15T17:30Z' } },

  // R4 Barber ‚Äì Sun 29 Mar, 13:00 ET (EDT UTC-4) = 17:00Z
  { city: 'Barber Motorsports Park', country: 'USA', region: 'Honda Indy Grand Prix of Alabama', round:'IC-4', series:['indy'], tz:'America/New_York', lat:33.56, lng:-86.44,
    sessions:{ race:'2026-03-29T17:00Z' } },

  // R5 Long Beach ‚Äì Sun 19 Apr, 17:30 ET (EDT UTC-4) = 21:30Z
  { city: 'Streets of Long Beach', country: 'USA', region: 'Acura Grand Prix of Long Beach', round:'IC-5', series:['indy'], tz:'America/Los_Angeles', lat:33.76, lng:-118.19,
    sessions:{ race:'2026-04-19T21:30Z' } },

  // R6 IMS Road Course ‚Äì Sat 9 May, 16:30 ET (EDT UTC-4) = 20:30Z
  { city: 'IMS Road Course', country: 'USA', region: 'Sonsio Grand Prix at IMS', round:'IC-6', series:['indy'], tz:'America/New_York', lat:39.79, lng:-86.24,
    sessions:{ race:'2026-05-09T20:30Z' } },

  // R7 Indianapolis 500 ‚Äì Sun 24 May, ~12:00 ET (EDT UTC-4) = 16:00Z
  { city: 'Indianapolis Motor Speedway', country: 'USA', region: '110th Indianapolis 500', round:'IC-7', series:['indy'], tz:'America/New_York', lat:39.79, lng:-86.24,
    sessions:{ race:'2026-05-24T16:00Z' } },

  // R8 Detroit ‚Äì Sun 31 May, 10:30 ET (EDT UTC-4) = 14:30Z
  { city: 'Streets of Detroit', country: 'USA', region: 'Detroit Grand Prix', round:'IC-8', series:['indy'], tz:'America/New_York', lat:42.33, lng:-83.05,
    sessions:{ race:'2026-05-31T14:30Z' } },

  // R9 Gateway (WWT Raceway) ‚Äì Sat 6 Jun, 17:30 ET (CDT UTC-5) = 22:30Z
  { city: 'World Wide Technology Raceway', country: 'USA', region: 'Bommarito Automotive Group 500', round:'IC-9', series:['indy'], tz:'America/Chicago', lat:38.64, lng:-90.16,
    sessions:{ race:'2026-06-06T22:30Z' } },

  // R10 Road America ‚Äì Sat 20 Jun, 12:30 ET (CDT UTC-5) = 17:30Z
  { city: 'Road America', country: 'USA', region: 'REV Group Grand Prix', round:'IC-10', series:['indy'], tz:'America/Chicago', lat:43.80, lng:-87.99,
    sessions:{ race:'2026-06-20T17:30Z' } },

  // R11 Mid-Ohio ‚Äì Sat 4 Jul, 13:00 ET (EDT UTC-4) = 17:00Z
  { city: 'Mid-Ohio Sports Car Course', country: 'USA', region: 'Honda Indy 200 at Mid-Ohio', round:'IC-11', series:['indy'], tz:'America/New_York', lat:40.69, lng:-82.65,
    sessions:{ race:'2026-07-04T17:00Z' } },

  // R12 Nashville ‚Äì Sat 19 Jul, TBD ET ~20:00 (CDT UTC-5) = ~01:00Z Sun
  { city: 'Nashville Superspeedway', country: 'USA', region: 'Music City Grand Prix', round:'IC-12', series:['indy'], tz:'America/Chicago', lat:36.18, lng:-86.26,
    sessions:{ race:'2026-07-20T01:00Z' } },

  // R13 Portland ‚Äì Sun 9 Aug, 14:00 ET (PDT UTC-7) = 21:00Z
  { city: 'Portland International Raceway', country: 'USA', region: 'Grand Prix of Portland', round:'IC-13', series:['indy'], tz:'America/Los_Angeles', lat:45.60, lng:-122.69,
    sessions:{ race:'2026-08-09T21:00Z' } },

  // R14 Markham (Canada) ‚Äì Sun 16 Aug, 12:00 ET (EDT UTC-4) = 16:00Z
  { city: 'Streets of Markham', country: 'Canada', region: 'Honda Indy Toronto (Markham)', round:'IC-14', series:['indy'], tz:'America/Toronto', lat:43.86, lng:-79.34,
    sessions:{ race:'2026-08-16T16:00Z' } },

  // R15 Milwaukee ‚Äì Sat 29 Aug, 14:30 ET (CDT UTC-5) = 19:30Z (race 1)
  { city: 'Milwaukee Mile', country: 'USA', region: 'Hy-Vee Milwaukee Mile 250s', round:'IC-15', series:['indy'], tz:'America/Chicago', lat:43.01, lng:-88.02,
    sessions:{ race:'2026-08-29T19:30Z', race2:'2026-08-30T18:00Z' } },

  // R16 Freedom 250 Washington D.C. ‚Äì Sun 23 Aug, ~13:00 ET (EDT UTC-4) = 17:00Z
  { city: 'National Mall Circuit', country: 'USA', region: 'Freedom 250 Grand Prix', round:'IC-16', series:['indy'], tz:'America/New_York', lat:38.89, lng:-77.03,
    sessions:{ race:'2026-08-23T17:00Z' } },

  // R17 Laguna Seca ‚Äì Sun 6 Sep, 14:30 ET (PDT UTC-7) = 21:30Z
  { city: 'WeatherTech Raceway Laguna Seca', country: 'USA', region: 'Firestone Grand Prix of Monterey', round:'IC-17', series:['indy'], tz:'America/Los_Angeles', lat:36.58, lng:-121.75,
    sessions:{ race:'2026-09-06T21:30Z' } },
];


// Time formatters
const timeFmt = {}, dateFmt = {};
cities.forEach(c => {
  timeFmt[c.tz] = new Intl.DateTimeFormat('en-GB', { timeZone: c.tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false });
  dateFmt[c.tz] = new Intl.DateTimeFormat('en-GB', { timeZone: c.tz, weekday:'short', day:'numeric', month:'short' });
});

function getPhase(tz) {
  const h = parseInt(new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour:'numeric', hour12:false }).format(new Date()));
  if (h >= 6 && h < 8) return 'dawn';
  if (h >= 8 && h < 18) return 'day';
  if (h >= 18 && h < 20) return 'dusk';
  return 'night';
}
function phaseLabel(p) { return {day:'Day',night:'Night',dawn:'Dawn',dusk:'Dusk'}[p]; }
function getOffset(tz) {
  const parts = new Intl.DateTimeFormat('en',{timeZone:tz,timeZoneName:'shortOffset'}).formatToParts(new Date());
  return parts.find(p=>p.type==='timeZoneName')?.value||'';
}

// ‚îÄ‚îÄ‚îÄ THREE.JS GLOBE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const container = document.getElementById('canvas-wrapper');
const W = () => container.clientWidth;
const H = () => container.clientHeight;

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(W(), H());
renderer.setClearColor(0x000000, 0);
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, W() / H(), 0.1, 1000);
camera.position.z = 3.2;

// Stars background
const starGeo = new THREE.BufferGeometry();
const starCount = 2000;
const starPos = new Float32Array(starCount * 3);
for (let i = 0; i < starCount * 3; i++) starPos[i] = (Math.random() - 0.5) * 200;
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.12, transparent: true, opacity: 0.5 });
scene.add(new THREE.Points(starGeo, starMat));

// Globe sphere
const globeRadius = 1.0;
const sphereGeo = new THREE.SphereGeometry(globeRadius, 64, 64);

// Load real Earth textures from public CDN
const texLoader = new THREE.TextureLoader();

// We'll use Natural Earth II styled textures from a reliable public source
// These are the NASA Blue Marble / Natural Earth textures
const EARTH_DAY   = 'https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg';
const EARTH_BUMP  = 'https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-topology.png';
const EARTH_SPEC  = 'https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-water.png';
const EARTH_NIGHT = 'https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg';

// Show loading indicator
const loadingEl = document.createElement('div');
loadingEl.id = 'loading';
loadingEl.innerHTML = `<div style="
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'DM Mono',monospace;font-size:0.7rem;letter-spacing:0.15em;
  text-transform:uppercase;color:rgba(200,255,0,0.6);text-align:center;
">
  <div style="margin-bottom:0.5rem">Loading globe textures‚Ä¶</div>
  <div style="width:120px;height:2px;background:rgba(255,255,255,0.1);margin:0 auto;overflow:hidden">
    <div id="load-bar" style="width:0%;height:100%;background:#c8ff00;transition:width 0.3s"></div>
  </div>
</div>`;
loadingEl.style.cssText = 'position:absolute;inset:0;z-index:20;pointer-events:none;';
document.getElementById('globe-container').appendChild(loadingEl);

let loadedCount = 0;
function onTexLoaded() {
  loadedCount++;
  const pct = (loadedCount / 4) * 100;
  const bar = document.getElementById('load-bar');
  if (bar) bar.style.width = pct + '%';
  if (loadedCount === 4) {
    setTimeout(() => {
      loadingEl.style.transition = 'opacity 0.5s';
      loadingEl.style.opacity = '0';
      setTimeout(() => loadingEl.remove(), 500);
    }, 200);
  }
}

const dayTex   = texLoader.load(EARTH_DAY,   onTexLoaded, undefined, onTexLoaded);
const bumpTex  = texLoader.load(EARTH_BUMP,  onTexLoaded, undefined, onTexLoaded);
const specTex  = texLoader.load(EARTH_SPEC,  onTexLoaded, undefined, onTexLoaded);
const nightTex = texLoader.load(EARTH_NIGHT, onTexLoaded, undefined, onTexLoaded);

// Custom shader material that blends day/night based on sun angle
const globeMat = new THREE.ShaderMaterial({
  uniforms: {
    dayTexture:   { value: dayTex },
    nightTexture: { value: nightTex },
    bumpTexture:  { value: bumpTex },
    specTexture:  { value: specTex },
    sunDirection: { value: new THREE.Vector3(1, 0.3, 1).normalize() },
  },
  vertexShader: `
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vWorldNormal;
    void main() {
      vUv = uv;
      vNormal = normalMatrix * normal;
      vWorldNormal = (modelMatrix * vec4(normal, 0.0)).xyz;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,
  fragmentShader: `
    uniform sampler2D dayTexture;
    uniform sampler2D nightTexture;
    uniform sampler2D bumpTexture;
    uniform sampler2D specTexture;
    uniform vec3 sunDirection;
    varying vec2 vUv;
    varying vec3 vNormal;
    varying vec3 vWorldNormal;

    void main() {
      vec3 norm = normalize(vWorldNormal);
      float sunDot = dot(norm, normalize(sunDirection));

      // Sample textures
      vec4 day   = texture2D(dayTexture,   vUv);
      vec4 night = texture2D(nightTexture, vUv);
      vec4 spec  = texture2D(specTexture,  vUv); // water mask

      // Blend day/night with a soft terminator
      float blend = smoothstep(-0.1, 0.35, sunDot);

      // Darken land on night side, keep city lights from night map
      vec4 color = mix(night * 1.2, day, blend);

      // Add slight specular highlight on water (spec map is white on water)
      float waterMask = spec.r;
      float specular = pow(max(0.0, dot(norm, normalize(sunDirection + vec3(0,0,1)))), 20.0);
      color.rgb += waterMask * specular * 0.3 * blend;

      // Subtle atmosphere limb darkening
      float limb = 1.0 - abs(dot(normalize(vNormal), vec3(0,0,1)));
      color.rgb = mix(color.rgb, color.rgb * 0.6, limb * 0.3);

      gl_FragColor = color;
    }
  `,
});

const globe = new THREE.Mesh(sphereGeo, globeMat);
scene.add(globe);

// Atmosphere glow ‚Äî thicker, more beautiful limb glow
const atmGeo = new THREE.SphereGeometry(globeRadius * 1.025, 64, 64);
const atmMat = new THREE.ShaderMaterial({
  uniforms: {
    sunDirection: { value: new THREE.Vector3(1, 0.3, 1).normalize() },
  },
  vertexShader: `
    varying vec3 vNormal;
    varying vec3 vWorldNormal;
    void main() {
      vNormal = normalMatrix * normal;
      vWorldNormal = (modelMatrix * vec4(normal, 0.0)).xyz;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,
  fragmentShader: `
    uniform vec3 sunDirection;
    varying vec3 vNormal;
    varying vec3 vWorldNormal;
    void main() {
      float intensity = pow(0.65 - dot(normalize(vNormal), vec3(0,0,1)), 4.0);
      float sunDot = dot(normalize(vWorldNormal), normalize(sunDirection));
      vec3 atmColor = mix(vec3(0.1, 0.3, 0.9), vec3(0.2, 0.6, 1.0), max(0.0, sunDot));
      gl_FragColor = vec4(atmColor, intensity * 0.7);
    }
  `,
  side: THREE.FrontSide,
  transparent: true,
  depthWrite: false,
  blending: THREE.AdditiveBlending,
});
scene.add(new THREE.Mesh(atmGeo, atmMat));

// Subtle ambient so scene isn't too dark
scene.add(new THREE.AmbientLight(0x111122, 0.4));

// Convert lat/lng to 3D position on sphere
function latLngTo3D(lat, lng, r) {
  const phi = (90 - lat) * (Math.PI / 180);
  const theta = (lng + 180) * (Math.PI / 180);
  return new THREE.Vector3(
    -r * Math.sin(phi) * Math.cos(theta),
     r * Math.cos(phi),
     r * Math.sin(phi) * Math.sin(theta)
  );
}

// City dot colours
function phaseColor(phase) {
  return { day: 0xc8ff00, dawn: 0xff9500, dusk: 0xff6b35, night: 0x6666bb }[phase];
}

// City markers on globe
const cityMeshes = [];
const dotGeo = new THREE.SphereGeometry(0.018, 10, 10);

// Pulse ring for selected city ‚Äî a flat torus that scales out and fades
const ringMeshes = [];
const ringGeo = new THREE.RingGeometry(0.018, 0.028, 32);
let selectedCityIdx = -1;
let pulseT = 0; // 0..1 animation progress, loops

cities.forEach((c, i) => {
  const phase = getPhase(c.tz);
  const mat = new THREE.MeshBasicMaterial({ color: phaseColor(phase) });
  const dot = new THREE.Mesh(dotGeo, mat);
  const pos = latLngTo3D(c.lat, c.lng, globeRadius + 0.012);
  dot.position.copy(pos);
  dot.userData = { cityIndex: i };
  globe.add(dot);
  cityMeshes.push(dot);

  // Ring sits at same position, faces outward (lookAt from globe centre)
  const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0, side: THREE.DoubleSide, depthWrite: false });
  const ring = new THREE.Mesh(ringGeo, ringMat);
  ring.position.copy(pos);
  // Orient ring to face outward (normal = pos direction)
  ring.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,1), pos.clone().normalize());
  ring.visible = false;
  globe.add(ring);
  ringMeshes.push(ring);
});

// Raycaster for click/hover
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

// Drag rotation
let isDragging = false;
let prevMouse = { x: 0, y: 0 };
let rotVel = { x: 0, y: 0 };
let autoRotate = true;

container.addEventListener('mousedown', e => {
  isDragging = true;
  autoRotate = false;
  prevMouse = { x: e.clientX, y: e.clientY };
  rotVel = { x: 0, y: 0 };
});

container.addEventListener('mousemove', e => {
  if (isDragging) {
    const dx = e.clientX - prevMouse.x;
    const dy = e.clientY - prevMouse.y;
    rotVel.x = dy * 0.005;
    rotVel.y = dx * 0.005;
    globe.rotation.x += rotVel.x;
    globe.rotation.y += rotVel.y;
    prevMouse = { x: e.clientX, y: e.clientY };
    hideTooltip();
    return;
  }

  // Hover detection
  const rect = container.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(cityMeshes);
  if (hits.length > 0) {
    container.style.cursor = 'pointer';
    const idx = hits[0].object.userData.cityIndex;
    showTooltip(idx, e.clientX - rect.left, e.clientY - rect.top);
    highlightSidebar(idx);
  } else {
    container.style.cursor = isDragging ? 'grabbing' : 'grab';
    hideTooltip();
  }
});

container.addEventListener('mouseup', e => {
  if (!isDragging) return;
  isDragging = false;
  // Click detection ‚Äî only fire if mouse barely moved (not a drag)
  const rect = container.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(cityMeshes);
  if (hits.length > 0) {
    const idx = hits[0].object.userData.cityIndex;
    showTooltip(idx, e.clientX - rect.left, e.clientY - rect.top);
    highlightSidebar(idx);
    openSessionPanel(idx);
  }
});

container.addEventListener('mouseleave', () => { isDragging = false; });

// Touch support
let lastTouch = null;
container.addEventListener('touchstart', e => {
  isDragging = true; autoRotate = false;
  lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  rotVel = { x: 0, y: 0 };
});
container.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!isDragging || !lastTouch) return;
  const dx = e.touches[0].clientX - lastTouch.x;
  const dy = e.touches[0].clientY - lastTouch.y;
  rotVel.x = dy * 0.005;
  rotVel.y = dx * 0.005;
  globe.rotation.x += rotVel.x;
  globe.rotation.y += rotVel.y;
  lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
}, { passive: false });
container.addEventListener('touchend', () => { isDragging = false; });

// Scroll to zoom
container.addEventListener('wheel', e => {
  // Don't zoom if the scroll originated inside the session panel
  if (e.target.closest('#session-panel')) return;
  camera.position.z = Math.max(1.5, Math.min(5, camera.position.z + e.deltaY * 0.003));
});

// ‚îÄ‚îÄ‚îÄ BADGE HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function seriesBadgesHTML(series) {
  const labels = { f1: 'F1', f2: 'F2', f3: 'F3', f1a: 'F1 Academy', fe: 'Formula E', indy: 'IndyCar' };
  return series.map(s => `<span class="badge badge-${s}">${labels[s]}</span>`).join('');
}

// ‚îÄ‚îÄ‚îÄ SESSION HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SESSION_LABELS = {
  fp1:'Practice 1', fp2:'Practice 2', fp3:'Practice 3',
  sq:'Sprint Quali', sprint:'Sprint Race',
  quali:'Qualifying', race:'F1 Race'
};
const SESSION_ORDER = ['fp1','fp2','sq','fp3','sprint','quali','race'];

const localSessionFmt = new Intl.DateTimeFormat('en-GB', {
  weekday:'short', month:'short', day:'numeric',
  hour:'2-digit', minute:'2-digit', hour12:false
});
function fmtLocal(utcStr) { return localSessionFmt.format(new Date(utcStr)); }

function formatCountdown(ms, shortForm) {
  if (ms <= 0) return null;
  const totalSec = Math.floor(ms / 1000);
  const d = Math.floor(totalSec / 86400);
  const h = Math.floor((totalSec % 86400) / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (shortForm && d > 0) return `${d}d`;
  if (d > 0) return `${d}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m`;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function daysUntilRace(utcStr) {
  const ms = new Date(utcStr) - Date.now();
  if (ms <= 0) return 'Done';
  const days = Math.ceil(ms / 86400000);
  if (days === 1) return '1 day';
  return `${days} days`;
}

// ‚îÄ‚îÄ‚îÄ FIND NEXT RACES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getNextOf(seriesKey) {
  const now = Date.now();
  const venues = cities.filter(c => c.series.includes(seriesKey));
  // For FE, use feSessions.race if available (shared venues with F1), else sessions.race
  const getDate = c => {
    if (seriesKey === 'fe' && c.feSessions && c.feSessions.race) return new Date(c.feSessions.race);
    return new Date(c.sessions.race);
  };
  // Sort by race date to get chronological order
  const sorted = [...venues].sort((a, b) => getDate(a) - getDate(b));
  return sorted.find(c => getDate(c).getTime() > now) || sorted[sorted.length - 1];
}

// Find the index of a city in the cities array matching a getNextOf result
function cityIndexOf(c) { return cities.indexOf(c); }

function initHeader() {
  const nf1  = getNextOf('f1');
  const nfe  = getNextOf('fe');
  const nind = getNextOf('indy');
  document.getElementById('hdr-f1-name').textContent   = nf1  ? nf1.region  : '‚Äî';
  document.getElementById('hdr-f1-loc').textContent    = nf1  ? `${nf1.city} ¬∑ ${nf1.country}`  : '‚Äî';
  document.getElementById('hdr-fe-name').textContent   = nfe  ? nfe.region  : '‚Äî';
  document.getElementById('hdr-fe-loc').textContent    = nfe  ? `${nfe.city} ¬∑ ${nfe.country}`  : '‚Äî';
  document.getElementById('hdr-indy-name').textContent = nind ? nind.region : '‚Äî';
  document.getElementById('hdr-indy-loc').textContent  = nind ? `${nind.city} ¬∑ ${nind.country}` : '‚Äî';
}
initHeader();

// Make header race blocks clickable ‚Äî spin globe and open session panel
[['hdr-f1-block','f1'],['hdr-fe-block','fe'],['hdr-indy-block','indy']].forEach(([id, key]) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.cursor = 'pointer';
  el.addEventListener('click', () => {
    const c = getNextOf(key);
    if (!c) return;
    const idx = cityIndexOf(c);
    if (idx < 0) return;
    highlightSidebar(idx);
    openSessionPanel(idx);
  });
});

// ‚îÄ‚îÄ‚îÄ FILTERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeFilter = 'all';

document.getElementById('filter-bar').addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn');
  if (!btn) return;
  const f = btn.dataset.filter;
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
  applyFilter();
});

function applyFilter() {
  let visible = 0;
  cities.forEach((c, i) => {
    const show = activeFilter === 'all' || c.series.includes(activeFilter);
    const item = document.getElementById(`ci-${i}`);
    if (item) item.classList.toggle('hidden', !show);
    // Update globe dot visibility
    if (cityMeshes[i]) cityMeshes[i].visible = show;
    if (show) visible++;
  });
  document.getElementById('sidebar-count').textContent = visible;
}

// ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const tooltip = document.getElementById('tooltip');
let activeCity = -1;

function showTooltip(idx, x, y) {
  if (activeFilter !== 'all' && !cities[idx].series.includes(activeFilter)) return;
  activeCity = idx;
  const c = cities[idx];
  const now = new Date();
  const phase = getPhase(c.tz);
  document.getElementById('tt-region').textContent = `Round ${c.round} ¬∑ ${c.region}`;
  document.getElementById('tt-city').textContent = c.city;
  document.getElementById('tt-country').textContent = c.country;
  document.getElementById('tt-badges').innerHTML = seriesBadgesHTML(c.series);
  document.getElementById('tt-time').textContent = daysUntilRace(c.sessions.race);
  document.getElementById('tt-date').textContent = dateFmt[c.tz].format(now);
  document.getElementById('tt-phase').textContent = phaseLabel(phase);
  document.getElementById('tt-offset').textContent = getOffset(c.tz);
  document.getElementById('tt-phase-dot').className = `phase-dot ${phase}`;

  const cw = container.clientWidth, ch = container.clientHeight;
  let tx = x + 14, ty = y - 16;
  if (tx + 270 > cw) tx = x - 275;
  if (ty + 200 > ch) ty = Math.max(8, ch - 205);
  tooltip.style.left = tx + 'px';
  tooltip.style.top = ty + 'px';
  tooltip.classList.add('visible');
}

function hideTooltip() {
  activeCity = -1;
  tooltip.classList.remove('visible');
}

// ‚îÄ‚îÄ‚îÄ SESSION PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activePanelCity = -1;
const sessionPanel = document.getElementById('session-panel');

document.getElementById('sp-close').addEventListener('click', closeSessionPanel);

function openSessionPanel(idx) {
  activePanelCity = idx;
  setSelectedCity(idx);
  switchFilterToCity(idx);
  const c = cities[idx];
  document.getElementById('sp-round').textContent = `Round ${c.round}`;
  document.getElementById('sp-name').textContent = c.region;
  document.getElementById('sp-venue').textContent = `${c.city} ¬∑ ${c.country}`;
  document.getElementById('sp-badges').innerHTML = seriesBadgesHTML(c.series);

  const now = Date.now();

  // Build a combined session list grouped by day, with each series colour-coded
  // Collect all sessions across all series into a flat array sorted by time
  const allSessions = [];

  // F1 sessions (only if this venue hosts F1)
  if (c.series.includes('f1')) {
    SESSION_ORDER.forEach(key => {
      if (!c.sessions[key]) return;
      allSessions.push({ time: new Date(c.sessions[key]), series: 'f1', key, label: SESSION_LABELS[key] });
    });
  }

  // Formula E / IndyCar standalone venues ‚Äî map their sessions as the primary series
  const FE_LABELS   = { race: 'E-Prix', race2: 'E-Prix 2', quali: 'Qualifying', fp: 'Free Practice' };
  const INDY_LABELS = { race: 'Race', race2: 'Race 2', quali: 'Qualifying', fp: 'Practice' };
  if (!c.series.includes('f1')) {
    const primarySeries = c.series.includes('fe') ? 'fe' : c.series.includes('indy') ? 'indy' : null;
    const primaryLabels = primarySeries === 'fe' ? FE_LABELS : INDY_LABELS;
    if (primarySeries) {
      Object.entries(c.sessions).forEach(([key, utc]) => {
        if (utc) allSessions.push({ time: new Date(utc), series: primarySeries, key, label: primaryLabels[key] || key });
      });
    }
  } else {
    // For shared F1+FE venues, also add FE badge sessions if any explicit feSessions exist
    if (c.feSessions) {
      Object.entries(c.feSessions).forEach(([key, utc]) => {
        allSessions.push({ time: new Date(utc), series: 'fe', key, label: FE_LABELS[key] || key });
      });
    }
  }

  // F2
  const F2_LABELS = { fp: 'Free Practice', quali: 'Qualifying', sprint: 'Sprint Race', feature: 'Feature Race' };
  if (c.f2Sessions) {
    Object.entries(c.f2Sessions).forEach(([key, utc]) => {
      allSessions.push({ time: new Date(utc), series: 'f2', key, label: F2_LABELS[key] || key });
    });
  }

  // F3
  const F3_LABELS = { fp: 'Practice', quali: 'Qualifying', sprint: 'Sprint Race', feature: 'Feature Race' };
  if (c.f3Sessions) {
    Object.entries(c.f3Sessions).forEach(([key, utc]) => {
      allSessions.push({ time: new Date(utc), series: 'f3', key, label: F3_LABELS[key] || key });
    });
  }

  // F1 Academy
  const F1A_LABELS = { quali: 'Qualifying', race1: 'Race 1', race2: 'Race 2' };
  if (c.f1aSessions) {
    Object.entries(c.f1aSessions).forEach(([key, utc]) => {
      allSessions.push({ time: new Date(utc), series: 'f1a', key, label: F1A_LABELS[key] || key });
    });
  }

  // Sort by time
  allSessions.sort((a, b) => a.time - b.time);

  // Group by local date
  const byDay = {};
  allSessions.forEach(s => {
    const dayKey = new Intl.DateTimeFormat('en-GB', { weekday:'long', day:'numeric', month:'short' }).format(s.time);
    if (!byDay[dayKey]) byDay[dayKey] = [];
    byDay[dayKey].push(s);
  });

  const seriesColour = { f1: '#ff6060', f2: '#60d4ff', f3: '#60ffb0', f1a: '#ffb060', fe: '#bb80ff', indy: '#ffe040' };
  const seriesLabel  = { f1: 'F1', f2: 'F2', f3: 'F3', f1a: 'F1A', fe: 'FE', indy: 'INDY' };

  let html = '';
  Object.entries(byDay).forEach(([day, sessions]) => {
    html += `<div class="sp-section-title">${day}</div>`;
    sessions.forEach(s => {
      const isPast = s.time.getTime() < now;
      const timeStr = new Intl.DateTimeFormat('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false }).format(s.time);
      const isMainRace = s.key === 'race' || s.key === 'feature';
      const raceEmoji = s.series === 'fe' ? '‚ö°' : 'üèÅ';
      const col = seriesColour[s.series];
      html += `<div class="sp-session-row">
        <span class="sp-series-tag" style="color:${col};min-width:28px;font-size:0.5rem;font-weight:500">${seriesLabel[s.series]}</span>
        <span class="sp-session-label${isMainRace ? ' is-race' : ''}" style="flex:1">${isMainRace ? raceEmoji + ' ' : ''}${s.label}</span>
        <span class="sp-session-time${isPast ? ' past' : ''}">${timeStr}</span>
      </div>`;
    });
  });
  document.getElementById('sp-sessions').innerHTML = html;

  // Race countdown
  const raceMs = new Date(c.sessions.race) - Date.now();
  const cdEl = document.getElementById('sp-countdown');
  const cdVal = document.getElementById('sp-countdown-value');
  const primaryS = c.series.includes('f1') ? 'f1' : c.series.includes('fe') ? 'fe' : 'indy';
  const startLabel = { f1: 'üèé F1 Race starts in', fe: '‚ö° E-Prix starts in', indy: 'üèé IndyCar Race starts in' }[primaryS];
  const doneLabel  = { f1: 'üèÅ F1 Race', fe: '‚ö° E-Prix', indy: 'üèÅ IndyCar Race' }[primaryS];
  if (raceMs > 0) {
    cdEl.style.display = 'block';
    cdVal.innerHTML = `<span>${formatCountdown(raceMs)}</span>`;
    document.querySelector('.sp-countdown-label').textContent = startLabel;
  } else {
    cdEl.style.display = 'block';
    cdVal.innerHTML = `<span class="sp-countdown-done">Race completed</span>`;
    document.querySelector('.sp-countdown-label').textContent = doneLabel;
  }

  sessionPanel.classList.add('open');
  if (typeof nudgeGlobeForPanel === 'function') nudgeGlobeForPanel(true);
  setTimeout(() => {
    updateCameraOffset();
    if (idx !== undefined) spinToCity(idx);
  }, 320);
  setTimeout(injectSessionPanelAds, 380);
}

// Inject ad blocks that fully fit in the visible space below the session content
function injectSessionPanelAds() {
  const scroll = document.getElementById('sp-scroll');
  const adsContainer = document.getElementById('sp-ads');
  if (!scroll || !adsContainer) return;

  adsContainer.innerHTML = '';

  requestAnimationFrame(() => requestAnimationFrame(() => {
    const AD_HEIGHT = 120;
    const AD_GAP    = 16;  // margin-top per block
    const BLOCK     = AD_HEIGHT + AD_GAP;

    // Measure how far down the actual content (above the ads div) reaches
    // relative to the scroll container's top
    const scrollTop  = scroll.getBoundingClientRect().top;
    const adsTop     = adsContainer.getBoundingClientRect().top;
    const contentH   = adsTop - scrollTop; // px of real content above the ads slot
    const visibleH   = scroll.clientHeight;

    const spare = visibleH - contentH;
    if (spare < BLOCK) return; // not even one full ad fits

    const count = Math.min(3, Math.floor(spare / BLOCK));
    adsContainer.innerHTML = Array.from({ length: count }, () =>
      `<div class="sp-ad-block ad-placeholder">üì¢ Ad ‚Äî Session Panel 250√ó120</div>`
    ).join('');
  }));
}

function closeSessionPanel() {
  activePanelCity = -1;
  setSelectedCity(-1);
  sessionPanel.classList.remove('open');
  if (typeof nudgeGlobeForPanel === 'function') nudgeGlobeForPanel(false);
  setTimeout(updateCameraOffset, 320);
}

// ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const cityListEl = document.getElementById('city-list');
cities.forEach((c, i) => {
  const raceDate = new Date(c.sessions.race);
  const raceDateStr = new Intl.DateTimeFormat('en-GB', { day:'numeric', month:'short' }).format(raceDate);
  const item = document.createElement('div');
  item.className = 'city-item';
  item.id = `ci-${i}`;
  item.dataset.idx = i;
  item.innerHTML = `
    <div class="ci-name">${c.region}</div>
    <div class="ci-country">
      <span style="color:var(--accent);font-size:0.5rem;letter-spacing:0.1em;margin-right:3px">R${c.round}</span>
      <span>${c.country}</span>
    </div>
    <div class="series-badges">${seriesBadgesHTML(c.series)}</div>
    <div class="ci-time" id="cit-${i}">--:--</div>
    <div class="ci-date" id="cid-${i}">${raceDateStr}</div>
  `;
  item.addEventListener('click', () => {
    highlightSidebar(i);
    openSessionPanel(i);
  });
  cityListEl.appendChild(item);
});
applyFilter(); // initialise count and visibility

function highlightSidebar(idx) {
  document.querySelectorAll('.city-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById(`ci-${idx}`);
  if (el) { el.classList.add('active'); el.scrollIntoView({ behavior:'smooth', block:'nearest' }); }
}

// Set/clear the pulsing selected city dot
function setSelectedCity(idx) {
  // Hide previous ring
  if (selectedCityIdx >= 0 && ringMeshes[selectedCityIdx]) {
    ringMeshes[selectedCityIdx].visible = false;
  }
  selectedCityIdx = idx;
  pulseT = 0;
  if (idx >= 0 && ringMeshes[idx]) {
    ringMeshes[idx].visible = true;
  }
}

// Auto-switch filter to match the selected race's primary series, make its dot visible
function switchFilterToCity(idx) {
  const c = cities[idx];
  // Determine the primary series to switch to
  const primarySeries = c.series.includes('f1') ? 'f1'
    : c.series.includes('fe') ? 'fe'
    : c.series.includes('indy') ? 'indy'
    : c.series[0];
  // Only switch if current filter hides this city
  if (activeFilter !== 'all' && !c.series.includes(activeFilter)) {
    activeFilter = primarySeries;
    document.querySelectorAll('.filter-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.filter === activeFilter)
    );
    applyFilter();
    // Scroll sidebar item into view after filter update
    const el = document.getElementById(`ci-${idx}`);
    if (el) el.scrollIntoView({ behavior:'smooth', block:'nearest' });
  }
}

// ‚îÄ‚îÄ‚îÄ SPIN GLOBE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spinToCity(idx) {
  const c = cities[idx];
  autoRotate = false;

  // Compute the dot's 3D position using the same formula as latLngTo3D,
  // then derive the rotation targets so that position faces the camera (+Z)
  const phi = (90 - c.lat) * (Math.PI / 180);
  const theta = (c.lng + 180) * (Math.PI / 180);
  const dx = -Math.sin(phi) * Math.cos(theta);
  const dy =  Math.cos(phi);
  const dz =  Math.sin(phi) * Math.sin(theta);

  // targetY: rotate so dx‚Üí0, dz‚Üímax (faces +Z). atan2(-dx, dz) gives the Y rotation needed.
  let targetY = Math.atan2(-dx, dz);

  // targetX: tilt so the point is at equator height facing camera.
  // After targetY, point is at (0, dy, horizDist). To centre vertically (y‚Üí0):
  // rotation.x = +atan2(dy, horizDist) ‚Äî positive brings northern cities down to centre
  const horizDist = Math.sqrt(dx * dx + dz * dz);
  let targetX = Math.atan2(dy, horizDist);
  targetX = Math.max(-Math.PI / 2.2, Math.min(Math.PI / 2.2, targetX));

  // Shortest-path wrap for Y so globe spins the short way around
  let curY = globe.rotation.y;
  while (curY - targetY > Math.PI)  targetY += Math.PI * 2;
  while (targetY - curY > Math.PI)  targetY -= Math.PI * 2;

  animateTo(targetX, targetY);
}

let animTarget = null;
function animateTo(tx, ty) { animTarget = { x: tx, y: ty }; }

// Camera centering: shift lookAt left when session panel is open
// so the visible centre of the globe aligns with the visible canvas area
const cameraLookAt = new THREE.Vector3(0, 0, 0);

function updateCameraOffset() {
  // Session panel is now inside the sidebar column, not overlapping the canvas
  // Globe always centres in the full canvas area
  cameraLookAt.x = 0;
  camera.lookAt(cameraLookAt);
}

// Resize ‚Äî renderer reads container's CSS dimensions each frame via W()/H()
function onResize() {
  renderer.setSize(W(), H(), false);
  camera.aspect = W() / H();
  camera.updateProjectionMatrix();
  updateCameraOffset();
}
window.addEventListener('resize', onResize);

// Also watch canvas-wrapper directly so we catch flex layout shifts
// (e.g. session panel opening/closing shrinks globe-container width)
new ResizeObserver(onResize).observe(document.getElementById('canvas-wrapper'));

// ‚îÄ‚îÄ‚îÄ ANIMATION LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE_CAM_Z = 3.2; // initial camera distance ‚Äî dots calibrated at this zoom
function animate() {
  requestAnimationFrame(animate);

  if (animTarget) {
    globe.rotation.x += (animTarget.x - globe.rotation.x) * 0.06;
    globe.rotation.y += (animTarget.y - globe.rotation.y) * 0.06;
    if (Math.abs(animTarget.x - globe.rotation.x) < 0.001 &&
        Math.abs(animTarget.y - globe.rotation.y) < 0.001) animTarget = null;
  } else if (!isDragging) {
    if (autoRotate) {
      globe.rotation.y += 0.0015;
    } else {
      globe.rotation.x += rotVel.x;
      globe.rotation.y += rotVel.y;
      rotVel.x *= 0.92;
      rotVel.y *= 0.92;
    }
  }
  globe.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, globe.rotation.x));

  // Keep dots constant screen size regardless of zoom level
  const dotScale = camera.position.z / BASE_CAM_Z;
  cityMeshes.forEach(m => m.scale.setScalar(dotScale));

  // Animate pulse ring on selected city
  if (selectedCityIdx >= 0) {
    pulseT = (pulseT + 0.012) % 1;
    const ring = ringMeshes[selectedCityIdx];
    if (ring && ring.visible) {
      const s = dotScale * (1 + pulseT * 3.5);
      ring.scale.setScalar(s);
      ring.material.opacity = (1 - pulseT) * 0.85;
      // Colour matches the dot
      ring.material.color.copy(cityMeshes[selectedCityIdx].material.color);
    }
  }

  camera.lookAt(cameraLookAt);
  renderer.render(scene, camera);
}
animate();

// ‚îÄ‚îÄ‚îÄ TICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick() {
  const now = new Date();

  // Update all three header countdowns
  const series = [
    { key: 'f1',   cdId: 'hdr-f1-countdown',   nameId: 'hdr-f1-name',   locId: 'hdr-f1-loc' },
    { key: 'fe',   cdId: 'hdr-fe-countdown',   nameId: 'hdr-fe-name',   locId: 'hdr-fe-loc' },
    { key: 'indy', cdId: 'hdr-indy-countdown', nameId: 'hdr-indy-name', locId: 'hdr-indy-loc' },
  ];
  series.forEach(({ key, cdId, nameId, locId }) => {
    const nr = getNextOf(key);
    if (!nr) return;
    document.getElementById(nameId).textContent = nr.region;
    document.getElementById(locId).textContent  = `${nr.city} ¬∑ ${nr.country}`;
    const ms = new Date(nr.sessions.race) - now;
    const el = document.getElementById(cdId);
    if (ms > 0) {
      el.textContent = formatCountdown(ms, isMobile && isMobile());
    } else {
      el.textContent = 'On now!';
    }
  });
  // After all countdowns set, check if header overflows ‚Äî if so shorten to days only
  requestAnimationFrame(() => {
    const hdr = document.querySelector('header');
    if (!hdr) return;
    // On mobile the countdown is already short-form ‚Äî skip desktop overflow logic
    if (isMobile && isMobile()) return;
    // First restore all blocks in case viewport grew
    ['hdr-indy-block','hdr-fe-block','hdr-indy-countdown-wrap','hdr-fe-countdown-wrap',
     document.querySelector('.header-divider:last-of-type')].forEach(el => {
      if (typeof el === 'string') { const e = document.getElementById(el); if (e) e.style.display = ''; }
      else if (el) el.style.display = '';
    });
    // Shorten all countdowns to days+h+m first
    [
      { id: 'hdr-f1-countdown',   key: 'f1'   },
      { id: 'hdr-fe-countdown',   key: 'fe'   },
      { id: 'hdr-indy-countdown', key: 'indy' },
    ].forEach(({ id, key }) => {
      const el = document.getElementById(id);
      if (!el) return;
      const nr2 = getNextOf(key);
      if (!nr2) return;
      const ms2 = new Date(nr2.sessions.race) - Date.now();
      if (ms2 > 0) el.textContent = formatCountdown(ms2, false);
    });
    // If still overflowing, hide IndyCar block
    if (hdr.scrollWidth > hdr.clientWidth + 4) {
      ['hdr-indy-block','hdr-indy-countdown-wrap'].forEach(id => {
        const e = document.getElementById(id); if (e) e.style.display = 'none';
      });
      // Hide the divider before IndyCar too
      const dividers = hdr.querySelectorAll('.header-divider');
      if (dividers.length >= 2) dividers[dividers.length - 1].style.display = 'none';
    }
    // If still overflowing, hide FE block too
    if (hdr.scrollWidth > hdr.clientWidth + 4) {
      ['hdr-fe-block','hdr-fe-countdown-wrap'].forEach(id => {
        const e = document.getElementById(id); if (e) e.style.display = 'none';
      });
      const dividers = hdr.querySelectorAll('.header-divider:not([style*="none"])');
      if (dividers.length >= 1) dividers[dividers.length - 1].style.display = 'none';
    }
    // If still overflowing, shorten all to days only
    if (hdr.scrollWidth > hdr.clientWidth + 4) {
      [
        { id: 'hdr-f1-countdown', key: 'f1' },
        { id: 'hdr-fe-countdown', key: 'fe' },
        { id: 'hdr-indy-countdown', key: 'indy' },
      ].forEach(({ id, key }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const nr2 = getNextOf(key);
        if (!nr2) return;
        const ms2 = new Date(nr2.sessions.race) - Date.now();
        if (ms2 > 0) el.textContent = formatCountdown(ms2, true);
      });
    }
  });

  // Sidebar days until race
  cities.forEach((c, i) => {
    const phase = getPhase(c.tz);
    if (cityMeshes[i] && cityMeshes[i].visible) {
      cityMeshes[i].material.color.setHex(phaseColor(phase));
    }
    const st = document.getElementById(`cit-${i}`);
    if (st) st.textContent = daysUntilRace(c.sessions.race);
  });

  // Tooltip days until race
  if (activeCity >= 0) {
    const el = document.getElementById('tt-time');
    if (el) el.textContent = daysUntilRace(cities[activeCity].sessions.race);
  }

  // Session panel countdown
  if (activePanelCity >= 0) {
    const c = cities[activePanelCity];
    const raceMs = new Date(c.sessions.race) - now;
    const cdVal = document.getElementById('sp-countdown-value');
    const cdLabel = document.querySelector('.sp-countdown-label');
    if (cdVal && raceMs > 0) {
      cdVal.innerHTML = `<span>${formatCountdown(raceMs)}</span>`;
      const ps = c.series.includes('f1') ? 'f1' : c.series.includes('fe') ? 'fe' : 'indy';
      const lbl = { f1: 'üèé F1 Race starts in', fe: '‚ö° E-Prix starts in', indy: 'üèé IndyCar Race starts in' }[ps];
      if (cdLabel) cdLabel.textContent = lbl;
    }
  }
}
tick();
setInterval(tick, 1000);

// ‚îÄ‚îÄ‚îÄ STARTUP: select next F1 race, no auto-rotation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function selectNextF1OnLoad() {
  const next = getNextOf('f1');
  if (!next) return;
  const idx = cityIndexOf(next);
  if (idx < 0) return;
  autoRotate = false;
  setTimeout(() => {
    highlightSidebar(idx);
    spinToCity(idx);
    // Don't open session panel on load ‚Äî user opens it by clicking
  }, 300);
})();

// ‚îÄ‚îÄ‚îÄ F1 TOUR ‚Äî arc line + idle auto-advance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// All F1 cities sorted chronologically by race date
const f1Tour = cities
  .filter(c => c.series.includes('f1'))
  .sort((a, b) => new Date(a.sessions.race) - new Date(b.sessions.race));

// Track user interaction ‚Äî any mouse/touch/wheel resets idle timer
let tourActive   = false;
let tourIdx      = 0;        // index into f1Tour
let tourTimer    = null;     // setTimeout handle
let idleTimer    = null;
let userTouched  = false;

// Arc line mesh ‚Äî lives on the globe so it rotates with it
let arcMesh = null;

const ARC_COLOR    = 0xff4444;   // red
const ARC_RADIUS   = globeRadius + 0.022; // just above dots
const IDLE_DELAY   = 10000;      // 10s before tour starts
const STEP_DELAY   = 10000;      // 10s per race

// Build a great-circle arc between two lat/lng points as a TubeGeometry
function buildArc(fromCity, toCity) {
  const a = latLngTo3D(fromCity.lat, fromCity.lng, ARC_RADIUS).normalize();
  const b = latLngTo3D(toCity.lat,   toCity.lng,   ARC_RADIUS).normalize();

  // Sample points along the great circle between a and b
  const SEGMENTS = 60;
  const points = [];
  for (let i = 0; i <= SEGMENTS; i++) {
    const t = i / SEGMENTS;
    // Slerp between a and b
    const dot   = Math.max(-1, Math.min(1, a.dot(b)));
    const omega = Math.acos(dot);
    let p;
    if (omega < 0.0001) {
      p = a.clone().lerp(b, t);
    } else {
      const sinOmega = Math.sin(omega);
      p = a.clone().multiplyScalar(Math.sin((1 - t) * omega) / sinOmega)
           .add(b.clone().multiplyScalar(Math.sin(t * omega) / sinOmega));
    }
    points.push(p.multiplyScalar(ARC_RADIUS));
  }

  const curve   = new THREE.CatmullRomCurve3(points);
  const tubeGeo = new THREE.TubeGeometry(curve, SEGMENTS, 0.004, 6, false);
  const tubeMat = new THREE.MeshBasicMaterial({
    color: ARC_COLOR,
    transparent: true,
    opacity: 0.85,
    depthWrite: false,
  });
  return new THREE.Mesh(tubeGeo, tubeMat);
}

// Remove existing arc from globe
function clearArc() {
  if (arcMesh) {
    globe.remove(arcMesh);
    arcMesh.geometry.dispose();
    arcMesh.material.dispose();
    arcMesh = null;
  }
}

// Advance to the next F1 race in the tour
function tourStep() {
  if (!tourActive) return;

  const city    = f1Tour[tourIdx];
  const prevIdx = tourIdx - 1; // -1 means we just wrapped to first race
  const isWrap  = prevIdx < 0;
  const prev    = isWrap ? null : f1Tour[prevIdx];

  clearArc();

  // Only draw arc when NOT wrapping from last race back to first
  if (!isWrap && prev) {
    const arc = buildArc(prev, city);
    globe.add(arc);
    arcMesh = arc;

    // Fade arc in
    arcMesh.material.opacity = 0;
    let fadeIn = 0;
    const fade = setInterval(() => {
      fadeIn += 0.05;
      if (arcMesh) arcMesh.material.opacity = Math.min(0.85, fadeIn * 0.85);
      if (fadeIn >= 1) clearInterval(fade);
    }, 30);
  }

  // Spin globe and update session panel
  const cityIdx = cityIndexOf(city);
  highlightSidebar(cityIdx);
  spinToCity(cityIdx);
  openSessionPanel(cityIdx);

  // Advance index ‚Äî wrap back to 0 (but use -1 sentinel so next step knows it wrapped)
  // We store the raw next index; on next call prevIdx = tourIdx - 1 detects the wrap
  tourIdx = tourIdx + 1;
  if (tourIdx >= f1Tour.length) tourIdx = 0;

  // Schedule next step
  tourTimer = setTimeout(tourStep, STEP_DELAY);
}

// Start the tour from the first F1 race (no arc on first step)
function startTour() {
  if (tourActive) return;
  tourActive = true;
  // Start at index 0; prevIdx will be -1 so no arc drawn on first step
  tourIdx = 0;
  tourStep();
}

// Stop the tour permanently
function stopTour() {
  tourActive = false;
  clearTimeout(tourTimer);
  clearArc();
}

// User interacted ‚Äî stop tour permanently, no restart
['mousemove', 'mousedown', 'keydown', 'wheel', 'touchstart', 'touchmove'].forEach(evt => {
  window.addEventListener(evt, stopTour, { passive: true });
});

// Start idle countdown on load ‚Äî tour begins after 10s if user hasn't touched anything
idleTimer = setTimeout(startTour, IDLE_DELAY);

// ‚îÄ‚îÄ‚îÄ MOTORSPORT NEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NEWS_FEEDS = [
  { url: 'https://www.autosport.com/rss/feed/f1',              badge: 'f1',   label: 'F1'        },
  { url: 'https://www.autosport.com/rss/feed/indycar',         badge: 'indy', label: 'IndyCar'   },
  { url: 'https://www.autosport.com/rss/feed/formula-e',       badge: 'fe',   label: 'Formula E' },
  { url: 'https://the-race.com/formula-1/feed/',               badge: 'f1',   label: 'F1'        },
  { url: 'https://the-race.com/formula-e/feed/',               badge: 'fe',   label: 'Formula E' },
  { url: 'https://the-race.com/indycar/feed/',                 badge: 'indy', label: 'IndyCar'   },
];

// CORS proxies to try in order
const CORS_PROXIES = [
  url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&count=6`,
];

function timeAgo(dateStr) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1)  return 'just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}

function stripHtml(str) {
  return (str || '').replace(/<[^>]*>/g, '').replace(/&(?:[a-z]+|#\d+);/gi, ' ').replace(/\s+/g, ' ').trim();
}

// Parse raw RSS XML string into items array
function parseRSS(xml) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xml, 'text/xml');
  const items = [...doc.querySelectorAll('item')];
  return items.map(item => {
    const get = tag => item.querySelector(tag)?.textContent || '';
    return {
      title:   get('title'),
      link:    get('link') || get('guid'),
      summary: stripHtml(get('description') || get('content\\:encoded')),
      date:    get('pubDate'),
    };
  }).filter(i => i.title && i.link);
}

// Try rss2json first (returns JSON), then raw XML via CORS proxies
async function fetchFeed({ url, badge, label }) {
  // 1. Try rss2json (cleanest)
  try {
    const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&count=6`, { signal: AbortSignal.timeout(6000) });
    if (r.ok) {
      const data = await r.json();
      if (data.status === 'ok' && data.items?.length) {
        return data.items.map(item => ({
          badge, label,
          title:   item.title || '',
          summary: stripHtml(item.description || item.content || ''),
          link:    item.link || item.guid || '#',
          date:    item.pubDate || '',
        }));
      }
    }
  } catch {}

  // 2. Try allorigins (returns raw XML in .contents)
  try {
    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(6000) });
    if (r.ok) {
      const data = await r.json();
      if (data.contents) {
        return parseRSS(data.contents).map(item => ({ badge, label, ...item }));
      }
    }
  } catch {}

  // 3. Try corsproxy.io (returns raw XML)
  try {
    const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(6000) });
    if (r.ok) {
      const xml = await r.text();
      return parseRSS(xml).map(item => ({ badge, label, ...item }));
    }
  } catch {}

  return [];
}

// Toggle open/close
const newsToggle = document.getElementById('news-toggle');
const newsBar    = document.getElementById('news-bar');
let newsLoaded   = false;
let allNewsItems = []; // all fetched items (up to 20)

function buildTicker(items) {
  const ticker = document.getElementById('news-ticker');
  if (!items.length) { ticker.innerHTML = ''; return; }
  // Duplicate items so the scroll loops seamlessly
  const half = items.map(item =>
    `<a class="ticker-item" href="${item.link}" target="_blank" rel="noopener noreferrer">
      <span class="ticker-badge ${item.badge}">${item.label}</span>
      ${item.title}
    </a>
    <span class="ticker-sep">¬∑</span>`
  ).join('');
  ticker.innerHTML = half + half; // duplicate for seamless loop

  // Adjust animation speed based on content width ‚Äî ~30px per second for readability
  const totalW = ticker.scrollWidth;
  const speed  = Math.max(40, totalW / 30); // ~30px per second
  ticker.style.animationDuration = `${speed}s`;
}

function buildDropdown(items) {
  const newsList = document.getElementById('news-list');
  if (!items.length) return;
  newsList.innerHTML = items.map(item => `
    <a class="news-item" href="${item.link}" target="_blank" rel="noopener noreferrer">
      <span class="news-badge ${item.badge}">${item.label}</span>
      <span class="news-headline">${item.title}</span>
      <span class="news-meta">${item.date ? timeAgo(item.date) : ''}</span>
      <span class="news-summary">${(item.summary || '').slice(0, 200)}${(item.summary || '').length > 200 ? '‚Ä¶' : ''}</span>
    </a>
  `).join('');
}

async function loadNews() {
  const newsCount  = document.getElementById('news-count');
  const newsList   = document.getElementById('news-list');
  const ticker     = document.getElementById('news-ticker');

  // Show loading state in ticker
  ticker.innerHTML = '<span style="color:var(--muted);font-size:0.65rem">Loading news‚Ä¶</span>';
  newsList.innerHTML = '<div class="news-loading">Loading latest motorsport news‚Ä¶</div>';

  const results  = await Promise.allSettled(NEWS_FEEDS.map(fetchFeed));
  const allItems = results.flatMap(r => r.status === 'fulfilled' ? r.value : []);

  if (allItems.length === 0) {
    ticker.innerHTML = '<span style="color:#ff6060;font-size:0.65rem">‚ö† News unavailable ‚Äî try disabling your ad blocker</span>';
    newsList.innerHTML = `<div class="news-error">‚ö† Could not load news feeds.<br>
      <span style="font-size:0.6rem;opacity:0.6">Ad blockers can prevent RSS proxy requests.</span></div>`;
    return;
  }

  // Deduplicate, sort newest first, cap at 20
  const seen = new Set();
  allNewsItems = allItems.filter(item => {
    const key = item.title.toLowerCase().replace(/\s+/g, '').slice(0, 50);
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  }).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20);

  newsCount.textContent = `${allNewsItems.length} stories`;
  buildTicker(getFilteredNews());
  buildDropdown(getFilteredNews());

  newsLoaded = true;
}

newsToggle.addEventListener('click', () => {
  const isOpen = newsBar.classList.toggle('open');
  newsToggle.classList.toggle('open', isOpen);
  const ticker = document.getElementById('news-ticker');
  ticker.style.animationPlayState = isOpen ? 'paused' : 'running';
  if (isOpen) {
    const newsList = document.getElementById('news-list');
    newsList.scrollTop = 0;
    // Measure actual 3-item height once open and layout has settled
    requestAnimationFrame(() => requestAnimationFrame(() => {
      const items = newsList.querySelectorAll('.news-item');
      if (items.length >= 3) {
        const h = Math.round(
          items[2].getBoundingClientRect().bottom -
          items[0].getBoundingClientRect().top
        );
        newsList.style.maxHeight = h + 'px';
        newsBar.style.maxHeight  = (h + 8) + 'px';
      }
    }));
  } else {
    // Clear inline styles so CSS max-height:0 takes over and bar collapses
    newsBar.style.maxHeight  = '';
    document.getElementById('news-list').style.maxHeight = '';
  }
});

// Load news automatically on page load
loadNews();

// ‚îÄ‚îÄ‚îÄ SIDEBAR COLLAPSE (desktop) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
const sidebarEl = document.querySelector('.sidebar');
sidebarCollapseBtn.addEventListener('click', () => {
  const collapsed = sidebarEl.classList.toggle('collapsed');
  sidebarCollapseBtn.textContent = collapsed ? '‚ñ∂' : '‚óÄ';
});

// ‚îÄ‚îÄ‚îÄ NEWS FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeNewsFilter = 'all';
function getFilteredNews() {
  return activeNewsFilter === 'f1'    ? allNewsItems.filter(i => i.badge === 'f1')
       : activeNewsFilter === 'other' ? allNewsItems.filter(i => i.badge !== 'f1')
       : allNewsItems;
}
document.querySelectorAll('.news-filter-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    activeNewsFilter = btn.dataset.filter;
    document.querySelectorAll('.news-filter-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.filter === activeNewsFilter));
    const filtered = getFilteredNews();
    buildTicker(filtered);
    buildDropdown(filtered);
  });
});

// ‚îÄ‚îÄ‚îÄ MOBILE: globe centering when session panel shown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nudgeGlobeForPanel(open) {
  if (!isMobile()) return;
  // Tilt camera lookAt up so the selected city sits above the 33vh panel
  const panelFraction = open ? 0.33 : 0;
  cameraLookAt.y = open ? -panelFraction * 0.6 : 0;
  camera.lookAt(cameraLookAt);
}

// ‚îÄ‚îÄ‚îÄ MOBILE: news filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mobNewsFilter = 'all';

function populateMobileNews() {
  const mobileNewsList = document.getElementById('news-list-mobile');
  const mobCount = document.getElementById('mob-news-count');
  let items = allNewsItems;
  if (mobNewsFilter === 'f1') {
    items = allNewsItems.filter(i => i.badge === 'f1');
  } else if (mobNewsFilter === 'other') {
    items = allNewsItems.filter(i => i.badge !== 'f1');
  }
  if (mobCount) mobCount.textContent = `¬∑ ${items.length} stories`;
  mobileNewsList.innerHTML = items.length ? items.map(item => `
    <a class="news-item" href="${item.link}" target="_blank" rel="noopener noreferrer">
      <span class="news-badge ${item.badge}">${item.label}</span>
      <span class="news-headline">${item.title}</span>
      <span class="news-meta">${item.date ? timeAgo(item.date) : ''}</span>
      <span class="news-summary">${(item.summary || '').slice(0, 200)}${(item.summary || '').length > 200 ? '‚Ä¶' : ''}</span>
    </a>
  `).join('') : '<div class="news-loading">No stories in this category.</div>';
}

document.querySelectorAll('.mob-news-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    mobNewsFilter = btn.dataset.filter;
    document.querySelectorAll('.mob-news-filter').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    populateMobileNews();
  });
});
// ‚îÄ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄo start below the header
function positionMobileOverlay(el) {
  if (!isMobile() || !el) return;
  const header = document.querySelector('header');
  if (!header) return;
  el.style.top = Math.round(header.getBoundingClientRect().bottom) + 'px';
}

function positionMobileRaceList() {
  positionMobileOverlay(document.getElementById('mobile-race-list'));
}

window.addEventListener('resize', () => {
  positionMobileRaceList();
  positionMobileOverlay(document.getElementById('mobile-news'));
});
setTimeout(() => {
  positionMobileRaceList();
  positionMobileOverlay(document.getElementById('mobile-news'));
}, 100);

function mobileTab(tab) {
  if (!isMobile()) return;

  document.querySelectorAll('.mob-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab)?.classList.add('active');

  const raceListOverlay = document.getElementById('mobile-race-list');
  const mobileNews      = document.getElementById('mobile-news');

  // Hide all overlays first
  raceListOverlay.classList.remove('visible');
  mobileNews.classList.remove('visible');

  if (tab === 'list') {
    positionMobileRaceList();

    if (!raceListOverlay.dataset.built) {
      raceListOverlay.dataset.built = '1';
      const sidebar = document.querySelector('.sidebar');
      raceListOverlay.innerHTML = sidebar.innerHTML;

      const cloneList = raceListOverlay.querySelector('.city-list');
      if (cloneList) { cloneList.style.flex = '1'; cloneList.style.overflowY = 'auto'; }

      raceListOverlay.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const f = btn.dataset.filter;
          activeFilter = f;
          document.querySelectorAll('.filter-btn').forEach(b =>
            b.classList.toggle('active', b.dataset.filter === f));
          applyFilter();
          syncMobileList();
        });
      });

      raceListOverlay.querySelectorAll('.city-item').forEach((clone, idx) => {
        clone.addEventListener('click', () => {
          mobileTab('globe');
          setTimeout(() => {
            highlightSidebar(idx);
            spinToCity(idx);
            openSessionPanel(idx);
          }, 80);
        });
      });
    }

    syncMobileList();
    raceListOverlay.classList.add('visible');

  } else if (tab === 'news') {
    positionMobileOverlay(mobileNews);
    mobileNews.classList.add('visible');

    // Populate mobile news list if not yet done
    const mobileNewsList = document.getElementById('news-list-mobile');
    if (!mobileNews.dataset.built && allNewsItems.length > 0) {
      mobileNews.dataset.built = '1';
      populateMobileNews();
    } else if (!mobileNews.dataset.built) {
      // News still loading ‚Äî check again shortly
      const check = setInterval(() => {
        if (allNewsItems.length > 0) {
          clearInterval(check);
          mobileNews.dataset.built = '1';
          populateMobileNews();
        }
      }, 300);
    }
  }
}

// Sync hidden/active state of cloned city items with the main list
function syncMobileList() {
  const raceListOverlay = document.getElementById('mobile-race-list');
  const mainItems  = document.querySelectorAll('#city-list .city-item');
  const cloneItems = raceListOverlay.querySelectorAll('.city-item');
  cloneItems.forEach((clone, i) => {
    const main = mainItems[i];
    if (!main) return;
    clone.classList.toggle('hidden',  main.classList.contains('hidden'));
    clone.classList.toggle('active',  main.classList.contains('active'));
  });
  // Sync count label
  const mainCount  = document.getElementById('sidebar-count');
  const cloneCount = raceListOverlay.querySelector('#sidebar-count');
  if (cloneCount && mainCount) cloneCount.textContent = mainCount.textContent;
}

// Close session panel when tapping outside it on mobile
document.addEventListener('touchstart', e => {
  if (!isMobile()) return;
  const panel = document.getElementById('session-panel');
  if (!panel.classList.contains('open')) return;
  if (!panel.contains(e.target)) closeSessionPanel();
}, { passive: true });

</script>
</body>
</html>
